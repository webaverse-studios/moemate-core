/*! For license information please see twitch.bundle.js.LICENSE.txt */
var e={587:e=>{function t(e,t){return Object.prototype.hasOwnProperty.call(e,t)}e.exports=function(e,n,s,i){n=n||"&",s=s||"=";var r={};if("string"!=typeof e||0===e.length)return r;var o=/\+/g;e=e.split(n);var a=1e3;i&&"number"==typeof i.maxKeys&&(a=i.maxKeys);var c=e.length;a>0&&c>a&&(c=a);for(var h=0;h<c;++h){var l,u,p,d,g=e[h].replace(o,"%20"),m=g.indexOf(s);m>=0?(l=g.substr(0,m),u=g.substr(m+1)):(l=g,u=""),p=decodeURIComponent(l),d=decodeURIComponent(u),t(r,p)?Array.isArray(r[p])?r[p].push(d):r[p]=[r[p],d]:r[p]=d}return r}},361:e=>{var t=function(e){switch(typeof e){case"string":return e;case"boolean":return e?"true":"false";case"number":return isFinite(e)?e:"";default:return""}};e.exports=function(e,n,s,i){return n=n||"&",s=s||"=",null===e&&(e=void 0),"object"==typeof e?Object.keys(e).map((function(i){var r=encodeURIComponent(t(i))+s;return Array.isArray(e[i])?e[i].map((function(e){return r+encodeURIComponent(t(e))})).join(n):r+encodeURIComponent(t(e[i]))})).join(n):i?encodeURIComponent(t(i))+s+encodeURIComponent(t(e)):""}},673:(e,t,n)=>{t.decode=t.parse=n(587),t.encode=t.stringify=n(361)},511:function(e,t,n){var s;e=n.nmd(e),function(i){t&&t.nodeType,e&&e.nodeType;var r="object"==typeof n.g&&n.g;r.global!==r&&r.window!==r&&r.self;var o,a=2147483647,c=36,h=26,l=38,u=700,p=/^xn--/,d=/[^\x20-\x7E]/,g=/[\x2E\u3002\uFF0E\uFF61]/g,m={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},f=c-1,y=Math.floor,v=String.fromCharCode;function _(e){throw RangeError(m[e])}function w(e,t){for(var n=e.length,s=[];n--;)s[n]=t(e[n]);return s}function b(e,t){var n=e.split("@"),s="";return n.length>1&&(s=n[0]+"@",e=n[1]),s+w((e=e.replace(g,".")).split("."),t).join(".")}function C(e){for(var t,n,s=[],i=0,r=e.length;i<r;)(t=e.charCodeAt(i++))>=55296&&t<=56319&&i<r?56320==(64512&(n=e.charCodeAt(i++)))?s.push(((1023&t)<<10)+(1023&n)+65536):(s.push(t),i--):s.push(t);return s}function k(e){return w(e,(function(e){var t="";return e>65535&&(t+=v((e-=65536)>>>10&1023|55296),e=56320|1023&e),t+v(e)})).join("")}function T(e,t){return e+22+75*(e<26)-((0!=t)<<5)}function R(e,t,n){var s=0;for(e=n?y(e/u):e>>1,e+=y(e/t);e>f*h>>1;s+=c)e=y(e/f);return y(s+(f+1)*e/(e+l))}function x(e){var t,n,s,i,r,o,l,u,p,d,g,m=[],f=e.length,v=0,w=128,b=72;for((n=e.lastIndexOf("-"))<0&&(n=0),s=0;s<n;++s)e.charCodeAt(s)>=128&&_("not-basic"),m.push(e.charCodeAt(s));for(i=n>0?n+1:0;i<f;){for(r=v,o=1,l=c;i>=f&&_("invalid-input"),((u=(g=e.charCodeAt(i++))-48<10?g-22:g-65<26?g-65:g-97<26?g-97:c)>=c||u>y((a-v)/o))&&_("overflow"),v+=u*o,!(u<(p=l<=b?1:l>=b+h?h:l-b));l+=c)o>y(a/(d=c-p))&&_("overflow"),o*=d;b=R(v-r,t=m.length+1,0==r),y(v/t)>a-w&&_("overflow"),w+=y(v/t),v%=t,m.splice(v++,0,w)}return k(m)}function E(e){var t,n,s,i,r,o,l,u,p,d,g,m,f,w,b,k=[];for(m=(e=C(e)).length,t=128,n=0,r=72,o=0;o<m;++o)(g=e[o])<128&&k.push(v(g));for(s=i=k.length,i&&k.push("-");s<m;){for(l=a,o=0;o<m;++o)(g=e[o])>=t&&g<l&&(l=g);for(l-t>y((a-n)/(f=s+1))&&_("overflow"),n+=(l-t)*f,t=l,o=0;o<m;++o)if((g=e[o])<t&&++n>a&&_("overflow"),g==t){for(u=n,p=c;!(u<(d=p<=r?1:p>=r+h?h:p-r));p+=c)b=u-d,w=c-d,k.push(v(T(d+b%w,0))),u=y(b/w);k.push(v(T(u,0))),r=R(n,f,s==i),n=0,++s}++n,++t}return k.join("")}o={version:"1.3.2",ucs2:{decode:C,encode:k},decode:x,encode:E,toASCII:function(e){return b(e,(function(e){return d.test(e)?"xn--"+E(e):e}))},toUnicode:function(e){return b(e,(function(e){return p.test(e)?x(e.slice(4).toLowerCase()):e}))}},void 0===(s=function(){return o}.call(t,n,t,e))||(e.exports=s)}()},575:(e,t,n)=>{var s=n(511),i=n(502);function r(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}t.parse=_,t.resolve=function(e,t){return _(e,!1,!0).resolve(t)},t.resolveObject=function(e,t){return e?_(e,!1,!0).resolveObject(t):t},t.format=function(e){return i.isString(e)&&(e=_(e)),e instanceof r?e.format():r.prototype.format.call(e)},t.Url=r;var o=/^([a-z0-9.+-]+:)/i,a=/:[0-9]*$/,c=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,h=["{","}","|","\\","^","`"].concat(["<",">",'"',"`"," ","\r","\n","\t"]),l=["'"].concat(h),u=["%","/","?",";","#"].concat(l),p=["/","?","#"],d=/^[+a-z0-9A-Z_-]{0,63}$/,g=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,m={javascript:!0,"javascript:":!0},f={javascript:!0,"javascript:":!0},y={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0},v=n(673);function _(e,t,n){if(e&&i.isObject(e)&&e instanceof r)return e;var s=new r;return s.parse(e,t,n),s}r.prototype.parse=function(e,t,n){if(!i.isString(e))throw new TypeError("Parameter 'url' must be a string, not "+typeof e);var r=e.indexOf("?"),a=-1!==r&&r<e.indexOf("#")?"?":"#",h=e.split(a);h[0]=h[0].replace(/\\/g,"/");var _=e=h.join(a);if(_=_.trim(),!n&&1===e.split("#").length){var w=c.exec(_);if(w)return this.path=_,this.href=_,this.pathname=w[1],w[2]?(this.search=w[2],this.query=t?v.parse(this.search.substr(1)):this.search.substr(1)):t&&(this.search="",this.query={}),this}var b=o.exec(_);if(b){var C=(b=b[0]).toLowerCase();this.protocol=C,_=_.substr(b.length)}if(n||b||_.match(/^\/\/[^@\/]+@[^@\/]+/)){var k="//"===_.substr(0,2);!k||b&&f[b]||(_=_.substr(2),this.slashes=!0)}if(!f[b]&&(k||b&&!y[b])){for(var T,R,x=-1,E=0;E<p.length;E++)-1!==(S=_.indexOf(p[E]))&&(-1===x||S<x)&&(x=S);for(-1!==(R=-1===x?_.lastIndexOf("@"):_.lastIndexOf("@",x))&&(T=_.slice(0,R),_=_.slice(R+1),this.auth=decodeURIComponent(T)),x=-1,E=0;E<u.length;E++){var S;-1!==(S=_.indexOf(u[E]))&&(-1===x||S<x)&&(x=S)}-1===x&&(x=_.length),this.host=_.slice(0,x),_=_.slice(x),this.parseHost(),this.hostname=this.hostname||"";var I="["===this.hostname[0]&&"]"===this.hostname[this.hostname.length-1];if(!I)for(var N=this.hostname.split(/\./),O=(E=0,N.length);E<O;E++){var A=N[E];if(A&&!A.match(d)){for(var P="",M=0,j=A.length;M<j;M++)A.charCodeAt(M)>127?P+="x":P+=A[M];if(!P.match(d)){var L=N.slice(0,E),$=N.slice(E+1),U=A.match(g);U&&(L.push(U[1]),$.unshift(U[2])),$.length&&(_="/"+$.join(".")+_),this.hostname=L.join(".");break}}}this.hostname.length>255?this.hostname="":this.hostname=this.hostname.toLowerCase(),I||(this.hostname=s.toASCII(this.hostname));var D=this.port?":"+this.port:"",q=this.hostname||"";this.host=q+D,this.href+=this.host,I&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),"/"!==_[0]&&(_="/"+_))}if(!m[C])for(E=0,O=l.length;E<O;E++){var F=l[E];if(-1!==_.indexOf(F)){var B=encodeURIComponent(F);B===F&&(B=escape(F)),_=_.split(F).join(B)}}var W=_.indexOf("#");-1!==W&&(this.hash=_.substr(W),_=_.slice(0,W));var G=_.indexOf("?");if(-1!==G?(this.search=_.substr(G),this.query=_.substr(G+1),t&&(this.query=v.parse(this.query)),_=_.slice(0,G)):t&&(this.search="",this.query={}),_&&(this.pathname=_),y[C]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){D=this.pathname||"";var H=this.search||"";this.path=D+H}return this.href=this.format(),this},r.prototype.format=function(){var e=this.auth||"";e&&(e=(e=encodeURIComponent(e)).replace(/%3A/i,":"),e+="@");var t=this.protocol||"",n=this.pathname||"",s=this.hash||"",r=!1,o="";this.host?r=e+this.host:this.hostname&&(r=e+(-1===this.hostname.indexOf(":")?this.hostname:"["+this.hostname+"]"),this.port&&(r+=":"+this.port)),this.query&&i.isObject(this.query)&&Object.keys(this.query).length&&(o=v.stringify(this.query));var a=this.search||o&&"?"+o||"";return t&&":"!==t.substr(-1)&&(t+=":"),this.slashes||(!t||y[t])&&!1!==r?(r="//"+(r||""),n&&"/"!==n.charAt(0)&&(n="/"+n)):r||(r=""),s&&"#"!==s.charAt(0)&&(s="#"+s),a&&"?"!==a.charAt(0)&&(a="?"+a),t+r+(n=n.replace(/[?#]/g,(function(e){return encodeURIComponent(e)})))+(a=a.replace("#","%23"))+s},r.prototype.resolve=function(e){return this.resolveObject(_(e,!1,!0)).format()},r.prototype.resolveObject=function(e){if(i.isString(e)){var t=new r;t.parse(e,!1,!0),e=t}for(var n=new r,s=Object.keys(this),o=0;o<s.length;o++){var a=s[o];n[a]=this[a]}if(n.hash=e.hash,""===e.href)return n.href=n.format(),n;if(e.slashes&&!e.protocol){for(var c=Object.keys(e),h=0;h<c.length;h++){var l=c[h];"protocol"!==l&&(n[l]=e[l])}return y[n.protocol]&&n.hostname&&!n.pathname&&(n.path=n.pathname="/"),n.href=n.format(),n}if(e.protocol&&e.protocol!==n.protocol){if(!y[e.protocol]){for(var u=Object.keys(e),p=0;p<u.length;p++){var d=u[p];n[d]=e[d]}return n.href=n.format(),n}if(n.protocol=e.protocol,e.host||f[e.protocol])n.pathname=e.pathname;else{for(var g=(e.pathname||"").split("/");g.length&&!(e.host=g.shift()););e.host||(e.host=""),e.hostname||(e.hostname=""),""!==g[0]&&g.unshift(""),g.length<2&&g.unshift(""),n.pathname=g.join("/")}if(n.search=e.search,n.query=e.query,n.host=e.host||"",n.auth=e.auth,n.hostname=e.hostname||e.host,n.port=e.port,n.pathname||n.search){var m=n.pathname||"",v=n.search||"";n.path=m+v}return n.slashes=n.slashes||e.slashes,n.href=n.format(),n}var _=n.pathname&&"/"===n.pathname.charAt(0),w=e.host||e.pathname&&"/"===e.pathname.charAt(0),b=w||_||n.host&&e.pathname,C=b,k=n.pathname&&n.pathname.split("/")||[],T=(g=e.pathname&&e.pathname.split("/")||[],n.protocol&&!y[n.protocol]);if(T&&(n.hostname="",n.port=null,n.host&&(""===k[0]?k[0]=n.host:k.unshift(n.host)),n.host="",e.protocol&&(e.hostname=null,e.port=null,e.host&&(""===g[0]?g[0]=e.host:g.unshift(e.host)),e.host=null),b=b&&(""===g[0]||""===k[0])),w)n.host=e.host||""===e.host?e.host:n.host,n.hostname=e.hostname||""===e.hostname?e.hostname:n.hostname,n.search=e.search,n.query=e.query,k=g;else if(g.length)k||(k=[]),k.pop(),k=k.concat(g),n.search=e.search,n.query=e.query;else if(!i.isNullOrUndefined(e.search))return T&&(n.hostname=n.host=k.shift(),(I=!!(n.host&&n.host.indexOf("@")>0)&&n.host.split("@"))&&(n.auth=I.shift(),n.host=n.hostname=I.shift())),n.search=e.search,n.query=e.query,i.isNull(n.pathname)&&i.isNull(n.search)||(n.path=(n.pathname?n.pathname:"")+(n.search?n.search:"")),n.href=n.format(),n;if(!k.length)return n.pathname=null,n.search?n.path="/"+n.search:n.path=null,n.href=n.format(),n;for(var R=k.slice(-1)[0],x=(n.host||e.host||k.length>1)&&("."===R||".."===R)||""===R,E=0,S=k.length;S>=0;S--)"."===(R=k[S])?k.splice(S,1):".."===R?(k.splice(S,1),E++):E&&(k.splice(S,1),E--);if(!b&&!C)for(;E--;E)k.unshift("..");!b||""===k[0]||k[0]&&"/"===k[0].charAt(0)||k.unshift(""),x&&"/"!==k.join("/").substr(-1)&&k.push("");var I,N=""===k[0]||k[0]&&"/"===k[0].charAt(0);return T&&(n.hostname=n.host=N?"":k.length?k.shift():"",(I=!!(n.host&&n.host.indexOf("@")>0)&&n.host.split("@"))&&(n.auth=I.shift(),n.host=n.hostname=I.shift())),(b=b||n.host&&k.length)&&!N&&k.unshift(""),k.length?n.pathname=k.join("/"):(n.pathname=null,n.path=null),i.isNull(n.pathname)&&i.isNull(n.search)||(n.path=(n.pathname?n.pathname:"")+(n.search?n.search:"")),n.auth=e.auth||n.auth,n.slashes=n.slashes||e.slashes,n.href=n.format(),n},r.prototype.parseHost=function(){var e=this.host,t=a.exec(e);t&&(":"!==(t=t[0])&&(this.port=t.substr(1)),e=e.substr(0,e.length-t.length)),e&&(this.hostname=e)}},502:e=>{e.exports={isString:function(e){return"string"==typeof e},isObject:function(e){return"object"==typeof e&&null!==e},isNull:function(e){return null===e},isNullOrUndefined:function(e){return null==e}}},274:e=>{e.exports.U=!1},932:e=>{e.exports=e=>{if("string"!=typeof e)throw new TypeError("Expected a string");return e.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&").replace(/-/g,"\\x2d")},e.exports.default=e.exports},826:(e,t,n)=>{var s=String.prototype.replace,i=/%20/g,r=n(544),o={RFC1738:"RFC1738",RFC3986:"RFC3986"};e.exports=r.assign({default:o.RFC3986,formatters:{RFC1738:function(e){return s.call(e,i,"+")},RFC3986:function(e){return String(e)}}},o)},625:(e,t,n)=>{var s=n(544),i=Object.prototype.hasOwnProperty,r=Array.isArray,o={allowDots:!1,allowPrototypes:!1,arrayLimit:20,charset:"utf-8",charsetSentinel:!1,comma:!1,decoder:s.decode,delimiter:"&",depth:5,ignoreQueryPrefix:!1,interpretNumericEntities:!1,parameterLimit:1e3,parseArrays:!0,plainObjects:!1,strictNullHandling:!1},a=function(e){return e.replace(/&#(\d+);/g,(function(e,t){return String.fromCharCode(parseInt(t,10))}))},c=function(e,t){return e&&"string"==typeof e&&t.comma&&e.indexOf(",")>-1?e.split(","):e},h=function(e,t){if(r(e)){for(var n=[],s=0;s<e.length;s+=1)n.push(t(e[s]));return n}return t(e)},l=function(e,t,n,s){if(e){var r=n.allowDots?e.replace(/\.([^.[]+)/g,"[$1]"):e,o=/(\[[^[\]]*])/g,a=n.depth>0&&/(\[[^[\]]*])/.exec(r),h=a?r.slice(0,a.index):r,l=[];if(h){if(!n.plainObjects&&i.call(Object.prototype,h)&&!n.allowPrototypes)return;l.push(h)}for(var u=0;n.depth>0&&null!==(a=o.exec(r))&&u<n.depth;){if(u+=1,!n.plainObjects&&i.call(Object.prototype,a[1].slice(1,-1))&&!n.allowPrototypes)return;l.push(a[1])}return a&&l.push("["+r.slice(a.index)+"]"),function(e,t,n,s){for(var i=s?t:c(t,n),r=e.length-1;r>=0;--r){var o,a=e[r];if("[]"===a&&n.parseArrays)o=[].concat(i);else{o=n.plainObjects?Object.create(null):{};var h="["===a.charAt(0)&&"]"===a.charAt(a.length-1)?a.slice(1,-1):a,l=parseInt(h,10);n.parseArrays||""!==h?!isNaN(l)&&a!==h&&String(l)===h&&l>=0&&n.parseArrays&&l<=n.arrayLimit?(o=[])[l]=i:o[h]=i:o={0:i}}i=o}return i}(l,t,n,s)}};e.exports=function(e,t){var n=function(e){if(!e)return o;if(null!==e.decoder&&void 0!==e.decoder&&"function"!=typeof e.decoder)throw new TypeError("Decoder has to be a function.");if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");var t=void 0===e.charset?o.charset:e.charset;return{allowDots:void 0===e.allowDots?o.allowDots:!!e.allowDots,allowPrototypes:"boolean"==typeof e.allowPrototypes?e.allowPrototypes:o.allowPrototypes,arrayLimit:"number"==typeof e.arrayLimit?e.arrayLimit:o.arrayLimit,charset:t,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:o.charsetSentinel,comma:"boolean"==typeof e.comma?e.comma:o.comma,decoder:"function"==typeof e.decoder?e.decoder:o.decoder,delimiter:"string"==typeof e.delimiter||s.isRegExp(e.delimiter)?e.delimiter:o.delimiter,depth:"number"==typeof e.depth||!1===e.depth?+e.depth:o.depth,ignoreQueryPrefix:!0===e.ignoreQueryPrefix,interpretNumericEntities:"boolean"==typeof e.interpretNumericEntities?e.interpretNumericEntities:o.interpretNumericEntities,parameterLimit:"number"==typeof e.parameterLimit?e.parameterLimit:o.parameterLimit,parseArrays:!1!==e.parseArrays,plainObjects:"boolean"==typeof e.plainObjects?e.plainObjects:o.plainObjects,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:o.strictNullHandling}}(t);if(""===e||null==e)return n.plainObjects?Object.create(null):{};for(var u="string"==typeof e?function(e,t){var n,l={},u=t.ignoreQueryPrefix?e.replace(/^\?/,""):e,p=t.parameterLimit===1/0?void 0:t.parameterLimit,d=u.split(t.delimiter,p),g=-1,m=t.charset;if(t.charsetSentinel)for(n=0;n<d.length;++n)0===d[n].indexOf("utf8=")&&("utf8=%E2%9C%93"===d[n]?m="utf-8":"utf8=%26%2310003%3B"===d[n]&&(m="iso-8859-1"),g=n,n=d.length);for(n=0;n<d.length;++n)if(n!==g){var f,y,v=d[n],_=v.indexOf("]="),w=-1===_?v.indexOf("="):_+1;-1===w?(f=t.decoder(v,o.decoder,m,"key"),y=t.strictNullHandling?null:""):(f=t.decoder(v.slice(0,w),o.decoder,m,"key"),y=h(c(v.slice(w+1),t),(function(e){return t.decoder(e,o.decoder,m,"value")}))),y&&t.interpretNumericEntities&&"iso-8859-1"===m&&(y=a(y)),v.indexOf("[]=")>-1&&(y=r(y)?[y]:y),i.call(l,f)?l[f]=s.combine(l[f],y):l[f]=y}return l}(e,n):e,p=n.plainObjects?Object.create(null):{},d=Object.keys(u),g=0;g<d.length;++g){var m=d[g],f=l(m,u[m],n,"string"==typeof e);p=s.merge(p,f,n)}return s.compact(p)}},607:(e,t,n)=>{var s=n(544),i=n(826),r=Object.prototype.hasOwnProperty,o={brackets:function(e){return e+"[]"},comma:"comma",indices:function(e,t){return e+"["+t+"]"},repeat:function(e){return e}},a=Array.isArray,c=Array.prototype.push,h=function(e,t){c.apply(e,a(t)?t:[t])},l=Date.prototype.toISOString,u=i.default,p={addQueryPrefix:!1,allowDots:!1,charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encoder:s.encode,encodeValuesOnly:!1,format:u,formatter:i.formatters[u],indices:!1,serializeDate:function(e){return l.call(e)},skipNulls:!1,strictNullHandling:!1},d=function e(t,n,i,r,o,c,l,u,d,g,m,f,y){var v,_=t;if("function"==typeof l?_=l(n,_):_ instanceof Date?_=g(_):"comma"===i&&a(_)&&(_=_.join(",")),null===_){if(r)return c&&!f?c(n,p.encoder,y,"key"):n;_=""}if("string"==typeof(v=_)||"number"==typeof v||"boolean"==typeof v||"symbol"==typeof v||"bigint"==typeof v||s.isBuffer(_))return c?[m(f?n:c(n,p.encoder,y,"key"))+"="+m(c(_,p.encoder,y,"value"))]:[m(n)+"="+m(String(_))];var w,b=[];if(void 0===_)return b;if(a(l))w=l;else{var C=Object.keys(_);w=u?C.sort(u):C}for(var k=0;k<w.length;++k){var T=w[k];o&&null===_[T]||(a(_)?h(b,e(_[T],"function"==typeof i?i(n,T):n,i,r,o,c,l,u,d,g,m,f,y)):h(b,e(_[T],n+(d?"."+T:"["+T+"]"),i,r,o,c,l,u,d,g,m,f,y)))}return b};e.exports=function(e,t){var n,s=e,c=function(e){if(!e)return p;if(null!==e.encoder&&void 0!==e.encoder&&"function"!=typeof e.encoder)throw new TypeError("Encoder has to be a function.");var t=e.charset||p.charset;if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");var n=i.default;if(void 0!==e.format){if(!r.call(i.formatters,e.format))throw new TypeError("Unknown format option provided.");n=e.format}var s=i.formatters[n],o=p.filter;return("function"==typeof e.filter||a(e.filter))&&(o=e.filter),{addQueryPrefix:"boolean"==typeof e.addQueryPrefix?e.addQueryPrefix:p.addQueryPrefix,allowDots:void 0===e.allowDots?p.allowDots:!!e.allowDots,charset:t,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:p.charsetSentinel,delimiter:void 0===e.delimiter?p.delimiter:e.delimiter,encode:"boolean"==typeof e.encode?e.encode:p.encode,encoder:"function"==typeof e.encoder?e.encoder:p.encoder,encodeValuesOnly:"boolean"==typeof e.encodeValuesOnly?e.encodeValuesOnly:p.encodeValuesOnly,filter:o,formatter:s,serializeDate:"function"==typeof e.serializeDate?e.serializeDate:p.serializeDate,skipNulls:"boolean"==typeof e.skipNulls?e.skipNulls:p.skipNulls,sort:"function"==typeof e.sort?e.sort:null,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:p.strictNullHandling}}(t);"function"==typeof c.filter?s=(0,c.filter)("",s):a(c.filter)&&(n=c.filter);var l,u=[];if("object"!=typeof s||null===s)return"";l=t&&t.arrayFormat in o?t.arrayFormat:t&&"indices"in t?t.indices?"indices":"repeat":"indices";var g=o[l];n||(n=Object.keys(s)),c.sort&&n.sort(c.sort);for(var m=0;m<n.length;++m){var f=n[m];c.skipNulls&&null===s[f]||h(u,d(s[f],f,g,c.strictNullHandling,c.skipNulls,c.encode?c.encoder:null,c.filter,c.sort,c.allowDots,c.serializeDate,c.formatter,c.encodeValuesOnly,c.charset))}var y=u.join(c.delimiter),v=!0===c.addQueryPrefix?"?":"";return c.charsetSentinel&&("iso-8859-1"===c.charset?v+="utf8=%26%2310003%3B&":v+="utf8=%E2%9C%93&"),y.length>0?v+y:""}},544:e=>{var t=Object.prototype.hasOwnProperty,n=Array.isArray,s=function(){for(var e=[],t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e}(),i=function(e,t){for(var n=t&&t.plainObjects?Object.create(null):{},s=0;s<e.length;++s)void 0!==e[s]&&(n[s]=e[s]);return n};e.exports={arrayToObject:i,assign:function(e,t){return Object.keys(t).reduce((function(e,n){return e[n]=t[n],e}),e)},combine:function(e,t){return[].concat(e,t)},compact:function(e){for(var t=[{obj:{o:e},prop:"o"}],s=[],i=0;i<t.length;++i)for(var r=t[i],o=r.obj[r.prop],a=Object.keys(o),c=0;c<a.length;++c){var h=a[c],l=o[h];"object"==typeof l&&null!==l&&-1===s.indexOf(l)&&(t.push({obj:o,prop:h}),s.push(l))}return function(e){for(;e.length>1;){var t=e.pop(),s=t.obj[t.prop];if(n(s)){for(var i=[],r=0;r<s.length;++r)void 0!==s[r]&&i.push(s[r]);t.obj[t.prop]=i}}}(t),e},decode:function(e,t,n){var s=e.replace(/\+/g," ");if("iso-8859-1"===n)return s.replace(/%[0-9a-f]{2}/gi,unescape);try{return decodeURIComponent(s)}catch(e){return s}},encode:function(e,t,n){if(0===e.length)return e;var i=e;if("symbol"==typeof e?i=Symbol.prototype.toString.call(e):"string"!=typeof e&&(i=String(e)),"iso-8859-1"===n)return escape(i).replace(/%u[0-9a-f]{4}/gi,(function(e){return"%26%23"+parseInt(e.slice(2),16)+"%3B"}));for(var r="",o=0;o<i.length;++o){var a=i.charCodeAt(o);45===a||46===a||95===a||126===a||a>=48&&a<=57||a>=65&&a<=90||a>=97&&a<=122?r+=i.charAt(o):a<128?r+=s[a]:a<2048?r+=s[192|a>>6]+s[128|63&a]:a<55296||a>=57344?r+=s[224|a>>12]+s[128|a>>6&63]+s[128|63&a]:(o+=1,a=65536+((1023&a)<<10|1023&i.charCodeAt(o)),r+=s[240|a>>18]+s[128|a>>12&63]+s[128|a>>6&63]+s[128|63&a])}return r},isBuffer:function(e){return!(!e||"object"!=typeof e||!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e)))},isRegExp:function(e){return"[object RegExp]"===Object.prototype.toString.call(e)},merge:function e(s,r,o){if(!r)return s;if("object"!=typeof r){if(n(s))s.push(r);else{if(!s||"object"!=typeof s)return[s,r];(o&&(o.plainObjects||o.allowPrototypes)||!t.call(Object.prototype,r))&&(s[r]=!0)}return s}if(!s||"object"!=typeof s)return[s].concat(r);var a=s;return n(s)&&!n(r)&&(a=i(s,o)),n(s)&&n(r)?(r.forEach((function(n,i){if(t.call(s,i)){var r=s[i];r&&"object"==typeof r&&n&&"object"==typeof n?s[i]=e(r,n,o):s.push(n)}else s[i]=n})),s):Object.keys(r).reduce((function(n,s){var i=r[s];return t.call(n,s)?n[s]=e(n[s],i,o):n[s]=i,n}),a)}}},29:(e,t,n)=>{var s=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==n.g)return n.g;throw new Error("unable to locate global object")}();e.exports=t=s.fetch,s.fetch&&(t.default=s.fetch.bind(s)),t.Headers=s.Headers,t.Request=s.Request,t.Response=s.Response}},t={};function n(s){var i=t[s];if(void 0!==i)return i.exports;var r=t[s]={id:s,loaded:!1,exports:{}};return e[s].call(r.exports,r,r.exports,n),r.loaded=!0,r.exports}n.d=(e,t)=>{for(var s in t)n.o(t,s)&&!n.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.nmd=e=>(e.paths=[],e.children||(e.children=[]),e);var s={};(()=>{n.d(s,{pi:()=>Qs,S1:()=>Vs,MA:()=>Js});var e={};n.r(e),n.d(e,{AwayNotify:()=>We,Batch:()=>nt,CapNotify:()=>st,ChgHost:()=>rt,InviteNotify:()=>ot,LabeledResponse:()=>ct,MessageTags:()=>ht,MultiPrefix:()=>lt});var t={};n.r(t),n.d(t,{Away:()=>$t,CapabilityNegotiation:()=>Gt,ChannelInvite:()=>Rt,ChannelJoin:()=>vt,ChannelKick:()=>xt,ChannelList:()=>Tt,ChannelPart:()=>_t,ClientQuit:()=>ft,ErrorMessage:()=>Lt,IsOnQuery:()=>Bt,Kill:()=>Pt,Mode:()=>bt,Names:()=>kt,NickChange:()=>dt,Notice:()=>It,OperLogin:()=>mt,Password:()=>pt,Ping:()=>Mt,Pong:()=>jt,PrivateMessage:()=>St,Rehash:()=>Ut,Restart:()=>Dt,ServerQuit:()=>yt,TagMessage:()=>Ht,Time:()=>Et,Topic:()=>Ct,UserHostQuery:()=>Ft,UserRegistration:()=>gt,Wallops:()=>qt,WhoIsQuery:()=>Ot,WhoQuery:()=>Nt,WhoWasQuery:()=>At});var i={};n.r(i),n.d(i,{Error401NoSuchNick:()=>xn,Error402NoSuchServer:()=>En,Error403NoSuchChannel:()=>Sn,Error404CanNotSendToChan:()=>In,Error405TooManyChannels:()=>Nn,Error410InvalidCapCmd:()=>On,Error421UnknownCommand:()=>An,Error422NoMotd:()=>Pn,Error431NoNickNameGiven:()=>Mn,Error432ErroneusNickname:()=>jn,Error433NickNameInUse:()=>Ln,Error436NickCollision:()=>$n,Error441UserNotInChannel:()=>Un,Error442NotOnChannel:()=>Dn,Error443UserOnChannel:()=>qn,Error451NotRegistered:()=>Fn,Error461NeedMoreParams:()=>Bn,Error462AlreadyRegistered:()=>Wn,Error471ChannelIsFull:()=>Gn,Error472UnknownMode:()=>Hn,Error473InviteOnlyChan:()=>zn,Error474BannedFromChan:()=>Qn,Error475BadChannelKey:()=>Kn,Error479BadChanName:()=>Jn,Error481NoPrivileges:()=>Vn,Error482ChanOpPrivsNeeded:()=>Yn,Error491NoOperHost:()=>Zn,Error501UmodeUnknownFlag:()=>Xn,Error502UsersDontMatch:()=>es,Reply001Welcome:()=>zt,Reply002YourHost:()=>Qt,Reply003Created:()=>Kt,Reply004ServerInfo:()=>Jt,Reply005Isupport:()=>Vt,Reply221UmodeIs:()=>Yt,Reply301Away:()=>Zt,Reply302UserHost:()=>Xt,Reply305UnAway:()=>en,Reply306NowAway:()=>tn,Reply311WhoisUser:()=>nn,Reply315EndOfWho:()=>sn,Reply318EndOfWhois:()=>rn,Reply319WhoisChannels:()=>on,Reply322List:()=>an,Reply323ListEnd:()=>cn,Reply324ChannelModeIs:()=>hn,Reply331NoTopic:()=>ln,Reply332Topic:()=>un,Reply333TopicWhoTime:()=>pn,Reply341Inviting:()=>dn,Reply348ExceptList:()=>gn,Reply349EndOfExceptList:()=>mn,Reply352WhoReply:()=>fn,Reply353NamesReply:()=>yn,Reply366EndOfNames:()=>vn,Reply367BanList:()=>_n,Reply368EndOfBanList:()=>wn,Reply372Motd:()=>bn,Reply375MotdStart:()=>Cn,Reply376EndOfMotd:()=>kn,Reply381YoureOper:()=>Tn,Reply391Time:()=>Rn});var r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},r(e,t)};function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var a=function(){return a=Object.assign||function(e){for(var t,n=1,s=arguments.length;n<s;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},a.apply(this,arguments)};function c(e,t,n,s){var i,r=arguments.length,o=r<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,n):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,s);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(o=(r<3?i(o):r>3?i(t,n,o):i(t,n))||o);return r>3&&o&&Object.defineProperty(t,n,o),o}function h(e,t,n,s){return new(n||(n=Promise))((function(i,r){function o(e){try{c(s.next(e))}catch(e){r(e)}}function a(e){try{c(s.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((s=s.apply(e,t||[])).next())}))}function l(e,t){var n,s,i,r,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return r={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function a(a){return function(c){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;r&&(r=0,a[0]&&(o=0)),o;)try{if(n=1,s&&(i=2&a[0]?s.return:a[0]?s.throw||((i=s.return)&&i.call(s),0):s.next)&&!(i=i.call(s,a[1])).done)return i;switch(s=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,s=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){o=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){o.label=a[1];break}if(6===a[0]&&o.label<i[1]){o.label=i[1],i=a;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(a);break}i[2]&&o.ops.pop(),o.trys.pop();continue}a=t.call(e,o)}catch(e){a=[6,e],s=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}}function u(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var s,i,r=n.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(s=r.next()).done;)o.push(s.value)}catch(e){i={error:e}}finally{try{s&&!s.done&&(n=r.return)&&n.call(r)}finally{if(i)throw i.error}}return o}function p(e,t,n){if(n||2===arguments.length)for(var s,i=0,r=t.length;i<r;i++)!s&&i in t||(s||(s=Array.prototype.slice.call(t,0,i)),s[i]=t[i]);return e.concat(s||Array.prototype.slice.call(t))}Object.create,Object.create,"function"==typeof SuppressedError&&SuppressedError;var d,g,m=n(274);function f(e){if("number"==typeof e){if(Object.prototype.hasOwnProperty.call(g,e))return e;var t=Object.keys(g).map((function(e){return parseInt(e,10)})).filter((function(t){return!isNaN(t)&&t<e}));return t.length?Math.max.apply(Math,t):g.WARNING}var n=e.replace(/\d+$/,"").toUpperCase();if(!Object.prototype.hasOwnProperty.call(g,n))throw new Error("Unknown log level string: ".concat(e));return g[n]}!function(e){e[e.CRITICAL=0]="CRITICAL",e[e.ERROR=1]="ERROR",e[e.WARNING=2]="WARNING",e[e.INFO=3]="INFO",e[e.DEBUG=4]="DEBUG",e[e.TRACE=7]="TRACE"}(g||(g={}));var y,v,_=m.U?console.log.bind(console):console.debug.bind(console),w=((d={})[g.CRITICAL]=console.error.bind(console),d[g.ERROR]=console.error.bind(console),d[g.WARNING]=console.warn.bind(console),d[g.INFO]=console.info.bind(console),d[g.DEBUG]=_.bind(console),d[g.TRACE]=console.trace.bind(console),d);function b(e){return null==e}function C(e,t){return b(e)?null:t(e)}function k(e,t){return b(e)?void 0:t(e)}var T="undefined"==typeof process?[]:null!==(v=null===(y=process.env.LOGGING)||void 0===y?void 0:y.split(";").map((function(e){var t=e.split("=",2),n=t[0],s=t[1];return s?["default"===n?void 0:n.split(":"),f(s)]:null})).filter((function(e){return!!e})).sort((function(e,t){var n,s,i=e[0],r=t[0];return(null!==(n=null==r?void 0:r.length)&&void 0!==n?n:0)-(null!==(s=null==i?void 0:i.length)&&void 0!==s?s:0)})))&&void 0!==v?v:[],R=T.findIndex((function(e){return!e[0]})),x=void 0;function E(e,t){return t.length<=e.length&&t.every((function(t,n){return t===e[n]}))}function S(e){for(var t=e.split(":"),n=0,s=T;n<s.length;n++){var i=s[n],r=i[0],o=i[1];if(E(t,r))return o}return x}-1!==R&&(x=T[R][1],T.splice(R));var I,N,O,A=function(){function e(e){var t,n,s=e.name,i=e.minLevel,r=e.emoji,o=void 0!==r&&r,a=e.colors,c=e.timestamps,h=void 0===c?m.U:c;this._name=s,this._minLevel=null!==(n=null!==(t=k(i,(function(e){return f(e)})))&&void 0!==t?t:S(s))&&void 0!==n?n:g.WARNING,this._emoji=o,this._colors=a,this._timestamps=h}return e.prototype.crit=function(e){this.log(g.CRITICAL,e)},e.prototype.error=function(e){this.log(g.ERROR,e)},e.prototype.warn=function(e){this.log(g.WARNING,e)},e.prototype.info=function(e){this.log(g.INFO,e)},e.prototype.debug=function(e){this.log(g.DEBUG,e)},e.prototype.trace=function(e){this.log(g.TRACE,e)},e}(),P=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return o(t,e),t.prototype.log=function(e,t){if(!(e>this._minLevel)){var n=w[e],s="[".concat(this._name,"] ").concat(t);this._timestamps&&(s="[".concat((new Date).toISOString(),"] ").concat(t)),n(s)}},t}(A),M=function(){function e(e){var t,n=e.name,s=e.minLevel,i=e.custom;this._minLevel=null!==(t=k(s,(function(e){return f(e)})))&&void 0!==t?t:S(n),this._override="function"==typeof i?{log:i}:i}return e.prototype.log=function(e,t){this._shouldLog(e)&&this._override.log(e,t)},e.prototype.crit=function(e){this._override.crit?this._shouldLog(g.CRITICAL)&&this._override.crit(e):this.log(g.CRITICAL,e)},e.prototype.error=function(e){this._override.error?this._shouldLog(g.ERROR)&&this._override.error(e):this.log(g.ERROR,e)},e.prototype.warn=function(e){this._override.warn?this._shouldLog(g.WARNING)&&this._override.warn(e):this.log(g.WARNING,e)},e.prototype.info=function(e){this._override.info?this._shouldLog(g.INFO)&&this._override.info(e):this.log(g.INFO,e)},e.prototype.debug=function(e){this._override.debug?this._shouldLog(g.DEBUG)&&this._override.debug(e):this.log(g.DEBUG,e)},e.prototype.trace=function(e){this._override.trace?this._shouldLog(g.TRACE)&&this._override.trace(e):this.log(g.TRACE,e)},e.prototype._shouldLog=function(e){return void 0===this._minLevel||this._minLevel>=e},e}(),j=((I={})[g.CRITICAL]="🛑",I[g.ERROR]="❌",I[g.WARNING]="⚠️ ",I[g.INFO]="ℹ️ ",I[g.DEBUG]="🐞",I[g.TRACE]="🐾",I),L={black:30,red:31,green:32,yellow:33,blue:34,magenta:35,cyan:36,white:37,blackBright:90,redBright:91,greenBright:92,yellowBright:93,blueBright:94,magentaBright:95,cyanBright:96,whiteBright:97},$={bgBlack:40,bgRed:41,bgGreen:42,bgYellow:43,bgBlue:44,bgMagenta:45,bgCyan:46,bgWhite:47,bgBlackBright:100,bgRedBright:101,bgGreenBright:102,bgYellowBright:103,bgBlueBright:104,bgMagentaBright:105,bgCyanBright:106,bgWhiteBright:107};function U(e,t,n){return function(s){return"[".concat(e,"m").concat(n?n(s):s,"[").concat(t,"m")}}function D(e){return U(L[e],39)}function q(e,t){return U($[e],49,t)}var F=((N={})[g.CRITICAL]=D("red"),N[g.ERROR]=D("redBright"),N[g.WARNING]=D("yellow"),N[g.INFO]=D("blue"),N[g.DEBUG]=D("magenta"),N[g.TRACE]=U(0,0),N),B=((O={})[g.CRITICAL]=q("bgRed",D("white")),O[g.ERROR]=q("bgRedBright",D("white")),O[g.WARNING]=q("bgYellow",D("black")),O[g.INFO]=q("bgBlue",D("white")),O[g.DEBUG]=q("bgMagenta",D("black")),O[g.TRACE]=U(7,27),O),W=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return o(t,e),t.prototype.log=function(e,t){var n,s,i;if(!(e>this._minLevel)){var r=w[e],o="";if(this._timestamps&&(o+="[".concat((new Date).toISOString(),"] ")),this._emoji){var a=j[e];o+="".concat(a," ")}r(o+=null===(i=null!==(n=this._colors)&&void 0!==n?n:null===(s=process.stdout)||void 0===s?void 0:s.isTTY)||void 0===i||i?"".concat(B[e](this._name)," ").concat(B[e](g[e])," ").concat(F[e](t)):"[".concat(this._name,":").concat(g[e].toLowerCase(),"] ").concat(t))}},t}(A);function G(e){return e.custom?new M(e):m.U?new W(e):new P(e)}var H=function(e){function t(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var s,i,r=this.constructor;return s=e.apply(this,p([],u(t),!1))||this,Object.setPrototypeOf(s,r.prototype),null===(i=Error.captureStackTrace)||void 0===i||i.call(Error,s,r.constructor),s}return o(t,e),Object.defineProperty(t.prototype,"name",{get:function(){return this.constructor.name},enumerable:!1,configurable:!0}),t}(Error),z=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return o(t,e),t}(H),Q=function(){function e(e){var t=e.logger,n=e.bucketSize,s=e.timeFrame,i=e.doRequest;this._queue=[],this._usedFromBucket=0,this._paused=!1,this._logger=G(a({name:"rate-limiter",emoji:!0},t)),this._bucketSize=n,this._timeFrame=s,this._callback=i}return e.prototype.request=function(e,t){return h(this,void 0,Promise,(function(){var n=this;return l(this,(function(s){switch(s.label){case 0:return[4,new Promise((function(s,i){var r,o={req:e,resolve:s,reject:i,limitReachedBehavior:null!==(r=null==t?void 0:t.limitReachedBehavior)&&void 0!==r?r:"enqueue"};if(n._usedFromBucket>=n._bucketSize||n._paused)switch(o.limitReachedBehavior){case"enqueue":n._queue.push(o),n._usedFromBucket+n._queue.length>=n._bucketSize?n._logger.warn("Rate limit of ".concat(n._bucketSize," was reached, waiting for ").concat(n._paused?"the limiter to be unpaused":"a free bucket entry","; queue size is ").concat(n._queue.length)):n._logger.info("Enqueueing request because the rate limiter is paused; queue size is ".concat(n._queue.length));break;case"null":o.resolve(null),n._logger.warn("Rate limit of ".concat(n._bucketSize," was reached, dropping request and returning null")),n._paused?n._logger.info("Returning null for request because the rate limiter is paused"):n._logger.warn("Rate limit of ".concat(n._bucketSize," was reached, dropping request and returning null"));break;case"throw":o.reject(new z("Request dropped because ".concat(n._paused?"the rate limiter is paused":"the rate limit was reached")));break;default:throw new Error("this should never happen")}else n._runRequest(o)}))];case 1:return[2,s.sent()]}}))}))},e.prototype.clear=function(){this._queue=[]},e.prototype.pause=function(){this._paused=!0},e.prototype.resume=function(){this._paused=!1,this._runNextRequest()},e.prototype._runRequest=function(e){return h(this,void 0,void 0,(function(){var t,n,s,i,r,o=this;return l(this,(function(a){switch(a.label){case 0:this._logger.debug("doing a request, new queue length is ".concat(this._queue.length)),this._usedFromBucket+=1,t=e.req,n=e.resolve,s=e.reject,a.label=1;case 1:return a.trys.push([1,3,4,5]),i=n,[4,this._callback(t)];case 2:return i.apply(void 0,[a.sent()]),[3,5];case 3:return r=a.sent(),s(r),[3,5];case 4:return setTimeout((function(){o._usedFromBucket-=1,o._queue.length&&o._usedFromBucket<o._bucketSize&&o._runNextRequest()}),this._timeFrame),[7];case 5:return[2]}}))}))},e.prototype._runNextRequest=function(){if(!this._paused){var e=this._queue.shift();e&&this._runRequest(e)}},e}(),K=function(e){function t(t,n){return e.call(this,a(a({},n),{doRequest:function(e,n){return h(this,void 0,Promise,(function(){return l(this,(function(s){switch(s.label){case 0:return[4,t.request(e,n)];case 1:return[2,s.sent()]}}))}))}}))||this}return o(t,e),t}(Q),J=function(){function e(e){var t=e.logger,n=e.bucketSize,s=e.timeFrame,i=e.doRequest,r=e.getPartitionKey;this._partitionedQueue=new Map,this._usedFromBucket=new Map,this._paused=!1,this._logger=G(a({name:"rate-limiter",emoji:!0},t)),this._bucketSize=n,this._timeFrame=s,this._callback=i,this._partitionKeyCallback=r}return e.prototype.request=function(e,t){return h(this,void 0,Promise,(function(){var n=this;return l(this,(function(s){switch(s.label){case 0:return[4,new Promise((function(s,i){var r,o,a={req:e,resolve:s,reject:i,limitReachedBehavior:null!==(r=null==t?void 0:t.limitReachedBehavior)&&void 0!==r?r:"enqueue"},c=n._partitionKeyCallback(e),h=null!==(o=n._usedFromBucket.get(c))&&void 0!==o?o:0;if(h>=n._bucketSize||n._paused)switch(a.limitReachedBehavior){case"enqueue":var l=n._getPartitionedQueue(c);l.push(a),h+l.length>=n._bucketSize?n._logger.warn("Rate limit of ".concat(n._bucketSize," for ").concat(c?"partition ".concat(c):"default partition"," was reached, waiting for ").concat(n._paused?"the limiter to be unpaused":"a free bucket entry","; queue size is ").concat(l.length)):n._logger.info("Enqueueing request for ".concat(c?"partition ".concat(c):"default partition"," because the rate limiter is paused; queue size is ").concat(l.length));break;case"null":a.resolve(null),n._paused?n._logger.info("Returning null for request for ".concat(c?"partition ".concat(c):"default partition"," because the rate limiter is paused")):n._logger.warn("Rate limit of ".concat(n._bucketSize," for ").concat(c?"partition ".concat(c):"default partition"," was reached, dropping request and returning null"));break;case"throw":a.reject(new z("Request dropped because ".concat(n._paused?"the rate limiter is paused":"the rate limit for ".concat(c?"partition ".concat(c):"default partition"," was reached"))));break;default:throw new Error("this should never happen")}else n._runRequest(a,c)}))];case 1:return[2,s.sent()]}}))}))},e.prototype.clear=function(){this._partitionedQueue.clear()},e.prototype.pause=function(){this._paused=!0},e.prototype.resume=function(){var e,t;this._paused=!1;try{for(var n=function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],s=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&s>=e.length&&(e=void 0),{value:e&&e[s++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}(this._partitionedQueue.keys()),s=n.next();!s.done;s=n.next()){var i=s.value;this._runNextRequest(i)}}catch(t){e={error:t}}finally{try{s&&!s.done&&(t=n.return)&&t.call(n)}finally{if(e)throw e.error}}},e.prototype._getPartitionedQueue=function(e){if(this._partitionedQueue.has(e))return this._partitionedQueue.get(e);var t=[];return this._partitionedQueue.set(e,t),t},e.prototype._runRequest=function(e,t){var n;return h(this,void 0,void 0,(function(){var s,i,r,o,a,c,h=this;return l(this,(function(l){switch(l.label){case 0:s=this._getPartitionedQueue(t),this._logger.debug("doing a request for ".concat(t?"partition ".concat(t):"default partition",", new queue length is ").concat(s.length)),this._usedFromBucket.set(t,(null!==(n=this._usedFromBucket.get(t))&&void 0!==n?n:0)+1),i=e.req,r=e.resolve,o=e.reject,l.label=1;case 1:return l.trys.push([1,3,4,5]),a=r,[4,this._callback(i)];case 2:return a.apply(void 0,[l.sent()]),[3,5];case 3:return c=l.sent(),o(c),[3,5];case 4:return setTimeout((function(){var e=h._usedFromBucket.get(t)-1;h._usedFromBucket.set(t,e),s.length&&e<h._bucketSize&&h._runNextRequest(t)}),this._timeFrame),[7];case 5:return[2]}}))}))},e.prototype._runNextRequest=function(e){if(!this._paused){var t=this._getPartitionedQueue(e).shift();t&&this._runRequest(t,e)}},e}();function V(){var e,t;return{promise:new Promise((function(n,s){e=n,t=s})),resolve:e,reject:t}}function Y(e){return h(this,void 0,Promise,(function(){return l(this,(function(t){switch(t.label){case 0:return"function"!=typeof e?[3,2]:[4,e()];case 1:return[2,t.sent()];case 2:return[2,e]}}))}))}function Z(e){var t,n,s;return l(this,(function(i){switch(i.label){case 0:t=0,n=1,i.label=1;case 1:return t<e?[4,t]:[3,3];case 2:return i.sent(),s=u([n,t+n],2),t=s[0],n=s[1],[3,1];case 3:return[4,e];case 4:return i.sent(),[3,3];case 5:return[2]}}))}function X(e){return void 0===e&&(e=!0),function(t,n){Object.defineProperty(t,n,{get:function(){},set:function(t){Object.defineProperty(this,n,{value:t,writable:!0,enumerable:e})},enumerable:e})}}class ee{constructor(e,t,n,s=!1){this.owner=e,this.event=t,this.listener=n,this._internal=s}unbind(){this.owner.removeListener(this)}}class te{constructor(){this._eventListeners=new Map,this._internalEventListeners=new Map}on(e,t){return this._addListener(!1,e,t)}addListener(e,t){return this._addListener(!1,e,t)}removeListener(e,t){this._removeListener(!1,e,t)}registerEvent(){const e=t=>this.addListener(e,t);return e}emit(e,...t){if(this._eventListeners.has(e))for(const n of this._eventListeners.get(e))n(...t);if(this._internalEventListeners.has(e))for(const n of this._internalEventListeners.get(e))n(...t)}registerInternalEvent(){const e=t=>this.addInternalListener(e,t);return e}addInternalListener(e,t){return this._addListener(!0,e,t)}removeInternalListener(e,t){this._removeListener(!0,e,t)}_addListener(e,t,n){const s=e?this._eventListeners:this._internalEventListeners;return s.has(t)?s.get(t).push(n):s.set(t,[n]),new ee(this,t,n,e)}_removeListener(e,t,n){const s=e?this._eventListeners:this._internalEventListeners;if(t)if("object"==typeof t){const e=t;this._removeListener(e._internal,e.event,e.listener)}else{const e=t;if(s.has(e))if(n){const t=s.get(e);let i=0;for(;-1!==(i=t.indexOf(n));)t.splice(i,1)}else s.delete(e)}else s.clear()}}class ne extends Error{constructor(e,t){var n;super(e,t),Object.setPrototypeOf(this,new.target.prototype),null===(n=Error.captureStackTrace)||void 0===n||n.call(Error,this,new.target.constructor)}get name(){return this.constructor.name}}class se extends ne{}const ie=6e4;function re(e){var t;return null!==(t=C(function(e){return C(e.expiresIn,(t=>e.obtainmentTimestamp+1e3*t-ie))}(e),(e=>Date.now()>e)))&&void 0!==t&&t}var oe=n(29),ae=oe.default||oe;const ce=function(e,t){return/^\/\//.test(e)&&(e="https:"+e),ae.call(this,e,t)},he=oe.Headers;oe.Request,oe.Response;var le=n(607);n(625),n(826);class ue extends ne{constructor(e,t,n,s,i,r){super(`Encountered HTTP status code ${e}: ${t}\n\nURL: ${n}\nMethod: ${s}\nBody:\n${!r&&i.length>150?`${i.slice(0,147)}...`:i}`),this._statusCode=e,this._url=n,this._method=s,this._body=i}get statusCode(){return this._statusCode}get url(){return this._url}get method(){return this._method}get body(){return this._body}}async function pe(e,t,n,s,i={}){const r=await async function(e,t,n,s,i={}){var r,o;const a=null!==(r=e.type)&&void 0!==r?r:"helix",c=function(e,t){switch(t){case"helix":return`https://api.twitch.tv/helix/${e.replace(/^\//,"")}`;case"auth":return`https://id.twitch.tv/oauth2/${e.replace(/^\//,"")}`;default:return e}}(e.url,a),h=le(e.query,{arrayFormat:"repeat",addQueryPrefix:!0}),l=new he({Accept:"application/json"});let u;e.jsonBody&&(u=JSON.stringify(e.jsonBody),l.append("Content-Type","application/json")),t&&"auth"!==a&&l.append("Client-ID",t),n&&l.append("Authorization",`${"helix"===a?null!=s?s:"Bearer":"OAuth"} ${n}`);const p={...i,method:null!==(o=e.method)&&void 0!==o?o:"GET",headers:l,body:u};return await ce(`${c}${h}`,p)}(e,t,n,s,i);return await async function(e,t){var n;if(!e.ok){const s="application/json"===e.headers.get("Content-Type"),i=s?JSON.stringify(await e.json(),null,2):await e.text(),r=le(t.query,{arrayFormat:"repeat",addQueryPrefix:!0}),o=`${t.url}${r}`;throw new ue(e.status,e.statusText,o,null!==(n=t.method)&&void 0!==n?n:"GET",i,s)}}(r,e),await async function(e){if(204===e.status)return;const t=await e.text();return t?JSON.parse(t):void 0}(r)}class de extends ne{constructor(e){super("Invalid token supplied",e)}}function ge(e,t){return{grant_type:"client_credentials",client_id:e,client_secret:t}}function me(e,t,n){return{grant_type:"refresh_token",client_id:e,client_secret:t,refresh_token:n}}const fe=Symbol("twurpleRawData");class ye{constructor(e){this[fe]=e}}function ve(e,t,n){return s=>{const i=n?function(){return`[${t}#${this[n]} - please check https://twurple.js.org/reference/${e}/classes/${t}.html for available properties]`}:function(){return`[${t} - please check https://twurple.js.org/reference/${e}/classes/${t}.html for available properties]`};Object.defineProperty(s.prototype,Symbol.for("nodejs.util.inspect.custom"),{value:i,enumerable:!1})}}let _e=class extends ye{constructor(e){super(e),this._obtainmentDate=new Date}get clientId(){return this[fe].client_id}get userId(){var e;return null!==(e=this[fe].user_id)&&void 0!==e?e:null}get userName(){var e;return null!==(e=this[fe].login)&&void 0!==e?e:null}get scopes(){return this[fe].scopes}get expiryDate(){return C(this[fe].expires_in,(e=>new Date(this._obtainmentDate.getTime()+1e3*e)))}};function we(e){var t,n;return{accessToken:e.access_token,refreshToken:e.refresh_token||null,scope:null!==(t=e.scope)&&void 0!==t?t:[],expiresIn:null!==(n=e.expires_in)&&void 0!==n?n:null,obtainmentTimestamp:Date.now()}}async function be(e,t,n){return we(await pe({type:"auth",url:"token",method:"POST",query:me(e,t,n)}))}async function Ce(e,t){try{const n=await pe({type:"auth",url:"validate"},t,e);return new _e(n)}catch(e){if(e instanceof ue&&401===e.statusCode)throw new de({cause:e});throw e}}_e=c([ve("auth","TokenInfo","clientId")],_e);const ke=new Map([["channel_commercial",["channel:edit:commercial"]],["channel_editor",["channel:manage:broadcast"]],["channel_read",["channel:read:stream_key"]],["channel_subscriptions",["channel:read:subscriptions"]],["user_blocks_read",["user:read:blocked_users"]],["user_blocks_edit",["user:manage:blocked_users"]],["user_follows_edit",["user:edit:follows"]],["user_read",["user:read:email"]],["user_subscriptions",["user:read:subscriptions"]],["user:edit:broadcast",["channel:manage:broadcast","channel:manage:extensions"]]]);function Te(e,t){if(null==t?void 0:t.length){const n=new Set(e.flatMap((e=>{var t;return[e,...null!==(t=ke.get(e))&&void 0!==t?t:[]]})));if(t.every((e=>!n.has(e)))){const e=t.join(", ");throw new Error(`This token does not have any of the requested scopes (${e}) and can not be upgraded.\nIf you need dynamically upgrading scopes, please implement the AuthProvider interface accordingly:\n\n\thttps://twurple.js.org/reference/auth/interfaces/AuthProvider.html`)}}}function Re(e,t){for(const n of t)Te(e,n)}async function xe(e,t,n,s,i){if((null==i?void 0:i.length)||!n){const n=await Ce(t,e);if(!n.userId)throw new Error("Trying to use an app access token as a user access token");const r=null!=s?s:n.scopes;return i&&Re(r,i),[r,n.userId]}return[s,n]}function Ee(e){return"string"==typeof e?e:"number"==typeof e?e.toString(10):e.id}class Se extends ne{constructor(e){super(`${e} - this should never happen, please file a bug in the GitHub issue tracker`)}}class Ie extends ne{constructor(e){super(`User ${e} was removed while trying to fetch a token.\n\nMake sure you're not executing any actions when you want to remove a user.`)}}class Ne extends ne{constructor(e){super(`Unknown intent: ${e}`),this.intent=e}}class Oe{constructor(e){this._newTokenScopeSets=[],this._newTokenPromise=null,this._queuedScopeSets=[],this._queueExecutor=null,this._queuePromise=null,this._executor=e}async fetch(e){var t;if(this._newTokenPromise){if(!(null==e?void 0:e.length))return await this._newTokenPromise;if(this._queueExecutor?this._queuedScopeSets.push(e):this._queuedScopeSets=[e],!this._queuePromise){const{promise:e,resolve:t,reject:n}=V();this._queuePromise=e,this._queueExecutor=async()=>{var e;if(this._queuePromise){this._newTokenScopeSets=this._queuedScopeSets,this._queuedScopeSets=[],this._newTokenPromise=this._queuePromise,this._queuePromise=null,this._queueExecutor=null;try{t(await this._executor(this._newTokenScopeSets))}catch(e){n(e)}finally{this._newTokenPromise=null,this._newTokenScopeSets=[],null===(e=this._queueExecutor)||void 0===e||e.call(this)}}}}return await this._queuePromise}this._newTokenScopeSets=(null==e?void 0:e.length)?[e]:[];const{promise:n,resolve:s,reject:i}=V();this._newTokenPromise=n;try{s(await this._executor(this._newTokenScopeSets))}catch(e){i(e)}finally{this._newTokenPromise=null,this._newTokenScopeSets=[],null===(t=this._queueExecutor)||void 0===t||t.call(this)}return await n}}let Ae=class{constructor(e){var t;this._userAccessTokens=new Map,this._userTokenFetchers=new Map,this._intentToUserId=new Map,this._userIdToIntents=new Map,this._clientId=e.clientId,this._clientSecret=e.clientSecret,this._onRefresh=e.onRefresh,this._appImpliedScopes=null!==(t=e.appImpliedScopes)&&void 0!==t?t:[],this._appTokenFetcher=new Oe((async e=>await this._fetchAppToken(e)))}addUser(e,t,n){const s=Ee(e);if(!t.refreshToken)throw new Error(`Trying to add user ${s} without refresh token`);this._userAccessTokens.set(s,{...t,userId:s}),this._userTokenFetchers.has(s)||this._userTokenFetchers.set(s,new Oe((async e=>await this._fetchUserToken(s,e)))),n&&this.addIntentsToUser(e,n)}async addUserForToken(e,t){let n=null;if(e.accessToken&&!re(e))try{n=[e,await Ce(e.accessToken)]}catch(e){if(!(e instanceof de))throw e}if(!n){if(!e.refreshToken)throw new de;const t=await be(this._clientId,this._clientSecret,e.refreshToken),s=await Ce(t.accessToken);this._callOnRefresh(s.userId,t),n=[t,s]}const[s,i]=n;if(!i.userId)throw new se("Could not determine a user ID for your token; you might be trying to disguise an app token as a user token.");const r=s.scope?s:{...s,scope:i.scopes};return this.addUser(i.userId,r,t),i.userId}hasUser(e){return this._userTokenFetchers.has(Ee(e))}removeUser(e){const t=Ee(e);if(this._userIdToIntents.has(t)){const e=this._userIdToIntents.get(t);for(const t of e)this._intentToUserId.delete(t);this._userIdToIntents.delete(t)}this._userAccessTokens.delete(t),this._userTokenFetchers.delete(t)}addIntentsToUser(e,t){const n=Ee(e);if(!this._userAccessTokens.has(n))throw new Error("Trying to add intents to a user that was not added to this provider");for(const e of t)this._intentToUserId.has(e)&&this._userIdToIntents.get(this._intentToUserId.get(e)).delete(e),this._intentToUserId.set(e,n),this._userIdToIntents.has(n)?this._userIdToIntents.get(n).add(e):this._userIdToIntents.set(n,new Set([e]))}getIntentsForUser(e){const t=Ee(e);return this._userIdToIntents.has(t)?Array.from(this._userIdToIntents.get(t)):[]}removeIntents(e){var t;for(const n of e)if(this._intentToUserId.has(n)){const e=this._intentToUserId.get(n);null===(t=this._userIdToIntents.get(e))||void 0===t||t.delete(n),this._intentToUserId.delete(n)}}async refreshAccessTokenForUser(e){const t=Ee(e),n=this._userAccessTokens.get(t);if(!n)throw new Error("Trying to refresh token for user that was not added to the provider");const s=await this._refreshUserTokenWithCallback(t,n.refreshToken);return this._checkIntermediateUserRemoval(t),this._userAccessTokens.set(t,{...s,userId:t}),this._callOnRefresh(t,s),{...s,userId:t}}async refreshAccessTokenForIntent(e){if(!this._intentToUserId.has(e))throw new Ne(e);const t=this._intentToUserId.get(e);return await this.refreshAccessTokenForUser(t)}get clientId(){return this._clientId}getCurrentScopesForUser(e){var t;const n=this._userAccessTokens.get(Ee(e));if(!n)throw new Error("Trying to get scopes for user that was not added to the provider");return null!==(t=n.scope)&&void 0!==t?t:[]}async getAccessTokenForUser(e,t){const n=this._userTokenFetchers.get(Ee(e));return n?await n.fetch(t):null}async getAccessTokenForIntent(e,t){if(!this._intentToUserId.has(e))return null;const n=this._intentToUserId.get(e),s=await this.getAccessTokenForUser(n,t);if(!s)throw new Se(`Found intent ${e} corresponding to user ID ${n} but no token was found`);return{...s,userId:n}}async getAnyAccessToken(e){if(e){const t=Ee(e);if(this._userAccessTokens.has(t)){const e=await this.getAccessTokenForUser(t);if(!e)throw new Se(`Token for user ID ${t} exists but nothing was returned by getAccessTokenForUser`);return{...e,userId:t}}}return await this.getAppAccessToken()}async getAppAccessToken(e=!1){return e&&(this._appAccessToken=void 0),await this._appTokenFetcher.fetch(this._appImpliedScopes)}_checkIntermediateUserRemoval(e){if(!this._userTokenFetchers.has(e))throw new Ie(e)}_callOnRefresh(e,t){this._onRefresh&&(this._onRefresh.length<2?(console.warn("DEPRECATION WARNING: please update your onRefresh callback to take a user ID as first parameter"),this._onRefresh(t)):this._onRefresh(e,t))}async _fetchUserToken(e,t){const n=this._userAccessTokens.get(e);if(!n)throw new Error("Trying to get token for user that was not added to the provider");if(n.accessToken&&!re(n))try{if(n.scope)return Re(n.scope,t),n;const[s=[]]=await xe(this._clientId,n.accessToken,e,n.scope,t),i={...n,scope:s};return this._checkIntermediateUserRemoval(e),this._userAccessTokens.set(e,i),i}catch(e){if(!(e instanceof de))throw e}this._checkIntermediateUserRemoval(e);const s=await this.refreshAccessTokenForUser(e);return Re(s.scope,t),s}async _refreshUserTokenWithCallback(e,t){var n;try{return await be(this.clientId,this._clientSecret,t)}catch(t){throw null===(n=this._onRefreshFailure)||void 0===n||n.call(this,e),t}}async _fetchAppToken(e){if(e.length>0)for(const t of e){if(!this._appImpliedScopes.length)throw new Error(`One of the scopes ${t.join(", ")} requested but the client credentials flow does not support scopes`);if(t.every((e=>!this._appImpliedScopes.includes(e))))throw new Error(`One of the scopes ${t.join(", ")} requested but only the scope ${this._appImpliedScopes.join(", ")} is implied`)}return!this._appAccessToken||re(this._appAccessToken)?await this._refreshAppToken():this._appAccessToken}async _refreshAppToken(){return this._appAccessToken=await async function(e,t){return we(await pe({type:"auth",url:"token",method:"POST",query:ge(e,t)}))}(this._clientId,this._clientSecret)}};c([X(!1)],Ae.prototype,"_clientSecret",void 0),c([X(!1)],Ae.prototype,"_userAccessTokens",void 0),c([X(!1)],Ae.prototype,"_userTokenFetchers",void 0),c([X(!1)],Ae.prototype,"_appAccessToken",void 0),c([X(!1)],Ae.prototype,"_appTokenFetcher",void 0),Ae=c([ve("auth","RefreshingAuthProvider","clientId")],Ae);var Pe=null;"undefined"!=typeof WebSocket?Pe=WebSocket:"undefined"!=typeof MozWebSocket?Pe=MozWebSocket:"undefined"!=typeof global?Pe=global.WebSocket||global.MozWebSocket:"undefined"!=typeof window?Pe=window.WebSocket||window.MozWebSocket:"undefined"!=typeof self&&(Pe=self.WebSocket||self.MozWebSocket);class Me extends te{constructor({lineBased:e,logger:t,additionalOptions:n}={}){super(),this._currentLine="",this._connecting=!1,this._connected=!1,this.onReceive=this.registerEvent(),this.onConnect=this.registerEvent(),this.onDisconnect=this.registerEvent(),this.onEnd=this.registerEvent(),this._lineBased=null!=e&&e,this._logger=t,this._additionalOptions=n}get isConnecting(){return this._connecting}get isConnected(){return this._connected}sendLine(e){this._connected&&(e=e.replace(/[\0\r\n]/g,""),this.sendRaw(`${e}\r\n`))}assumeExternalDisconnect(){var e;null===(e=this._logger)||void 0===e||e.trace("AbstrctConnection assumeExternalDisconnect"),this._connected=!1,this._connecting=!1,this.emit(this.onDisconnect,!1)}receiveRaw(e){var t,n;if(!this._lineBased)return void this.emit(this.onReceive,e);const s=e.split("\r\n");if(this._currentLine+=null!==(t=s.shift())&&void 0!==t?t:"",s.length){this.emit(this.onReceive,this._currentLine),this._currentLine=null!==(n=s.pop())&&void 0!==n?n:"";for(const e of s)this.emit(this.onReceive,e)}}}class je extends Me{constructor(e,t){if(super(t),this._socket=null,this._closingOnDemand=!1,e.hostName&&e.port)this._url=`ws${e.secure?"s":""}://${e.hostName}:${e.port}`;else{if(!e.url)throw new Error("WebSocketConnection requires either hostName & port or url to be set");this._url=e.url}}get hasSocket(){return!!this._socket}sendRaw(e){var t;null===(t=this._socket)||void 0===t||t.send(e)}connect(){var e,t;null===(e=this._logger)||void 0===e||e.trace("WebSocketConnection connect"),this._connecting=!0,this._socket=new Pe(this._url,null===(t=this._additionalOptions)||void 0===t?void 0:t.wsOptions),this._socket.onopen=()=>{var e;null===(e=this._logger)||void 0===e||e.trace("WebSocketConnection onOpen"),this._connected=!0,this._connecting=!1,this.emit(this.onConnect)},this._socket.onmessage=({data:e})=>{this.receiveRaw(e.toString())},this._socket.onerror=e=>{var t;null===(t=this._logger)||void 0===t||t.trace(`WebSocketConnection onError message:${e.message}`)},this._socket.onclose=e=>{var t;const n=this._connected,s=this._connecting;if(null===(t=this._logger)||void 0===t||t.trace(`WebSocketConnection onClose wasConnected:${n.toString()} wasConnecting:${s.toString()} closingOnDemand:${this._closingOnDemand.toString()} wasClean:${e.wasClean.toString()}`),this._connected=!1,this._connecting=!1,e.wasClean||this._closingOnDemand)this._closingOnDemand=!1,this.emit(this.onDisconnect,!0),this.emit(this.onEnd,!0);else{const t=new Error(`[${e.code}] ${e.reason}`);this.emit(this.onDisconnect,!1,t),this.emit(this.onEnd,!1,t)}this._socket&&(this._socket.onopen=null,this._socket.onmessage=null,this._socket.onerror=null,this._socket.onclose=null,this._socket=null)}}disconnect(){var e,t;null===(e=this._logger)||void 0===e||e.trace("WebSocketConnection disconnect"),this._closingOnDemand=!0,null===(t=this._socket)||void 0===t||t.close()}}class Le{constructor(){throw new Error("DirectConnection is not implemented in a browser environment")}}class $e extends te{constructor(e,t,n={}){var s;super(),this._type=e,this._target=t,this._config=n,this._retryLimit=1/0,this._initialRetryLimit=3,this._connecting=!1,this._connectionRetryCount=0,this.onReceive=this.registerEvent(),this.onConnect=this.registerEvent(),this.onDisconnect=this.registerEvent(),this.onEnd=this.registerEvent(),this._retryLimit=null!==(s=n.retryLimit)&&void 0!==s?s:1/0,this._logger=n.logger}get isConnected(){var e,t;return null!==(t=null===(e=this._currentConnection)||void 0===e?void 0:e.isConnected)&&void 0!==t&&t}get isConnecting(){var e,t;return null!==(t=null===(e=this._currentConnection)||void 0===e?void 0:e.isConnecting)&&void 0!==t?t:this._connecting}get hasSocket(){var e,t;return null!==(t=null===(e=this._currentConnection)||void 0===e?void 0:e.hasSocket)&&void 0!==t&&t}sendLine(e){var t;null===(t=this._currentConnection)||void 0===t||t.sendLine(e)}connect(){if(this._currentConnection||this._connecting)throw new Error("Connection already present");this._connecting=!0,this._connectionRetryCount=0,this._tryConnect(!0)}disconnect(){var e;if(null===(e=this._logger)||void 0===e||e.trace(`PersistentConnection disconnect currentConnectionExists:${Boolean(this._currentConnection).toString()} connecting:${this._connecting.toString()}`),this._connecting=!1,this._currentConnection){const e=this._currentConnection;this._currentConnection=void 0,e.disconnect()}}assumeExternalDisconnect(){var e,t;null===(e=this._logger)||void 0===e||e.trace("PersistentConnection assumeExternalDisconnect"),null===(t=this._currentConnection)||void 0===t||t.assumeExternalDisconnect()}reconnect(){this._reconnect(!0)}acknowledgeSuccessfulReconnect(){this._previousConnection&&(this._previousConnection.disconnect(),this._previousConnection=void 0)}_startTryingToConnect(e=!1){this._connecting=!0,this._connectionRetryCount=0,this._tryConnect(e)}_tryConnect(e=!1){var t,n;null===(t=this._logger)||void 0===t||t.trace(`PersistentConnection tryConnect currentConnectionExists:${Boolean(this._currentConnection).toString()} connecting:${this._connecting.toString()}`);const s=e?this._initialRetryLimit:this._retryLimit;null!==(n=this._retryTimerGenerator)&&void 0!==n||(this._retryTimerGenerator=Z(120));const i=this._currentConnection=new this._type("function"==typeof(r=this._target)?r():r,this._config);var r;i.onReceive((e=>this.emit(this.onReceive,e))),i.onConnect((()=>{this.emit(this.onConnect),this._connecting=!1,this._retryTimerGenerator=void 0})),i.onDisconnect(((t,n)=>{var r,o,a;if(this.emit(this.onDisconnect,t,n),t)this.emit(this.onEnd,!0),this._connecting=!1,this._retryTimerGenerator=void 0,i.disconnect(),this._currentConnection===i&&(this._currentConnection=void 0),this._previousConnection===i&&(this._previousConnection=void 0);else if(this._connecting){if(null===(r=this._logger)||void 0===r||r.debug(`Connection error caught: ${null!==(o=null==n?void 0:n.message)&&void 0!==o?o:"unknown error"}`),this._connectionRetryCount>=s)return;this._connectionRetryCount++;const t=this._retryTimerGenerator.next().value;0!==t&&(null===(a=this._logger)||void 0===a||a.info(`Retrying in ${t} seconds`)),setTimeout((()=>{var t;this._connecting&&(null===(t=this._logger)||void 0===t||t.info(e?"Retrying connection":"Trying to reconnect"),this._tryConnect())}),1e3*t)}else this._reconnect()})),i.connect()}_reconnect(e=!1){e&&this._config.overlapManualReconnect?(this._previousConnection=this._currentConnection,this._currentConnection=void 0):this.disconnect(),this._startTryingToConnect(e)}}function Ue(e,t){return Object.assign.apply(Object,p([{}],u(e.map(t)),!1))}function De(e,t,n){var s=e.split(t);return s.length<=n?s:p(p([],u(s.slice(0,n-1)),!1),[s.slice(n-1).join(t)],!1)}function qe(e,t,n){if("number"==typeof e&&(e=e.toString()),(t-=e.length)<=0)return e;void 0===n&&(n=" ");var s="";do{1==(1&t)&&(s+=n),(t>>=1)&&(n+=n)}while(t);return s+e}function Fe(e,t){Object.entries(e).forEach((function(e){var n=u(e,2),s=n[0],i=n[1];return t(i,s)}))}function Be(e){var t,n,s;if(Array.isArray(e)){for(n=Array(t=e.length);t--;)n[t]=(s=e[t])&&"object"==typeof s?Be(s):s;return n}if("[object Object]"===Object.prototype.toString.call(e)){for(t in n={},e)"__proto__"===t?Object.defineProperty(n,t,{value:Be(e[t]),configurable:!0,enumerable:!0,writable:!0}):n[t]=(s=e[t])&&"object"==typeof s?Be(s):s;return n}return e}const We={name:"away-notify"};class Ge extends Error{constructor(e,t,n){super(`command "${e}" expected ${t} or more parameters, got ${n}`),this._command=e,this._expectedParams=t,this._actualParams=n,Object.setPrototypeOf(this,Ge.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,Ge)}get command(){return this._command}get expectedParams(){return this._expectedParams}get actualParams(){return this._actualParams}}class He extends Error{constructor(e,t,n,s){var i;super(`required parameter "${t}" did not validate against ${null!==(i=n.type)&&void 0!==i?i:"regex"} validation: "${s}"`),this._command=e,this._paramName=t,this._paramSpec=n,this._givenValue=s,Object.setPrototypeOf(this,He.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,He)}get command(){return this._command}get paramName(){return this._paramName}get paramSpec(){return this._paramSpec}get givenValue(){return this._givenValue}}const ze={channelTypes:"#&",supportedUserModes:"iwso",supportedChannelModes:{prefix:"ov",list:"b",alwaysWithParam:"ovk",paramWhenSet:"l",noParam:"imnpst"},prefixes:[{modeChar:"v",prefix:"+"},{modeChar:"o",prefix:"@"}]};var Qe=n(932);function Ke(e,t="#&"){return new RegExp(`^[${Qe(t)}][^ \b\0\n\r,]+$`).test(e)}const Je={0:"\0",n:"\n",r:"\r","":""};function Ve(e){if(!e.startsWith(""))return!1;if((e=e.substring(1)).endsWith("")&&(e=e.slice(0,-1)),!e)return!1;e=e.replace(/\x10(.)/,((e,t)=>t in Je?Je[t]:""));let[t,n=""]=De(e," ",2);return t=t?t.toUpperCase():"",{command:t,params:n}}const Ye={"\\":"\\",";":":","\n":"n","\r":"r"," ":"s"};class Ze{static checkParam(e,t,n=ze){return!("channel"===t.type&&!Ke(e,n.channelTypes))&&(!("channelList"===t.type&&!e.split(",").every((e=>Ke(e,n.channelTypes))))&&!(t.match&&!t.match.test(e)))}static getMinParamCount(e=!1){return this.PARAM_SPEC?Object.values(this.PARAM_SPEC).filter((t=>!(t.noServer&&e||t.noClient&&!e||t.optional))).length:0}constructor(e,t,n,s,i=ze,r,o=!1,a=!0){this._params=[],this._serverProperties=ze,this._command=e,this._params=t,this._tags=null!=n?n:new Map,this._prefix=s,this._serverProperties=i,this._raw=r,a&&this.parseParams(o)}get paramCount(){var e,t;return null!==(t=null===(e=this._params)||void 0===e?void 0:e.length)&&void 0!==t?t:0}prefixToString(){return this._prefix?function(e){let t=`${e.nick}`;return e.user&&(t+=`!${e.user}`),e.host&&(t+=`@${e.host}`),t}(this._prefix):""}tagsToString(){return[...this._tags.entries()].map((([e,t])=>{return t?`${e}=${n=t,n.replace(/[\\;\n\r ]/g,(e=>`\\${Ye[e]}`))}`:e;var n})).join(";")}toString(e=!1,t=!1){const n=[t?this._buildCommandFromRawParams():this._buildCommandFromNamedParams()];if(e){const e=this.prefixToString();e&&n.unshift(`:${e}`)}const s=this.tagsToString();return s&&n.unshift(`@${s}`),n.join(" ")}_initPrefixAndTags(e,t){this._prefix=e,t&&(this._tags=t)}parseParams(e=!1){if(this._params){const t=this.constructor;let n=t.getMinParamCount(e);if(n>this._params.length)throw new Ge(this._command,n,this._params.length);const s=t.PARAM_SPEC;if(!s)return;let i=0;const r={};for(const[t,o]of Object.entries(s)){if(o.noServer&&e)continue;if(o.noClient&&!e)continue;if(this._params.length-i<=n){if(o.optional)continue;if(this._params.length-i!==n)throw new Error("not enough parameters left for required parameters parsing (this is a library bug)")}let s=this._params[i];if(!s){if(o.optional)break;throw new Error("unexpected parameter underflow")}if(o.rest){const e=[];for(;this._params[i]&&!this._params[i].trailing;)e.push(this._params[i].value),++i;if(!e.length){if(o.optional)continue;throw new Error(`no parameters left for required rest parameter "${t}"`)}s={value:e.join(" "),trailing:!1}}if(Ze.checkParam(s.value,o))r[t]={...s},o.optional||--n,o.rest||++i;else if(!o.optional)throw new He(this._command,t,o,s.value);if(o.trailing)break}Object.assign(this,r)}}get params(){const e=this.constructor,t=e.PARAM_SPEC?Object.keys(e.PARAM_SPEC):[];return Object.assign({},...t.map((e=>{const t=this[e];if(t)return[e,t.value]})).filter((e=>void 0!==e)).map((([e,t])=>({[e]:t}))))}get rawParamValues(){var e,t;return null!==(t=null===(e=this._params)||void 0===e?void 0:e.map((e=>e.value)))&&void 0!==t?t:[]}get prefix(){return this._prefix}get command(){return this._command}get tags(){return this._tags}get rawLine(){return this._raw}isResponseTo(e){return!1}endsResponseTo(e){return!1}_acceptsInReplyCollection(e){return e.isResponseTo(this)}_buildCommandFromNamedParams(){const e=this.constructor,t=e.PARAM_SPEC?Object.keys(e.PARAM_SPEC):[];return[this._command,...t.map((e=>{const t=this[e];if(t)return(t.trailing?":":"")+t.value})).filter((e=>void 0!==e))].join(" ")}_buildCommandFromRawParams(){var e,t;return[this._command,...null!==(t=null===(e=this._params)||void 0===e?void 0:e.map((e=>`${e.trailing?":":""}${e.value}`)))&&void 0!==t?t:[]].join(" ")}}Ze.COMMAND="",Ze.SUPPORTS_CAPTURE=!1;const Xe=e=>t=>{if(n=t,!Object.prototype.isPrototypeOf.call(Ze,n))throw new Error("You need to extend the Message class to use the MessageType decorator");var n;t.COMMAND=e},et=(e={})=>(t,n)=>{var s;if(!(t instanceof Ze))throw new Error("You need to extend the Message class to use the MessageParam decorator");if("string"!=typeof n)return;const i=t.constructor;(null!==(s=i.PARAM_SPEC)&&void 0!==s?s:i.PARAM_SPEC={})[n]=e};let tt=class extends Ze{};c([et()],tt.prototype,"reference",void 0),c([et({optional:!0})],tt.prototype,"type",void 0),c([et({optional:!0})],tt.prototype,"additionalParams",void 0),tt=c([Xe("BATCH")],tt);const nt={name:"batch",messageTypes:[tt],usesTags:!0},st={name:"cap-notify"};let it=class extends Ze{};c([et()],it.prototype,"newUser",void 0),c([et()],it.prototype,"newHost",void 0),it=c([Xe("CHGHOST")],it);const rt={name:"chghost",messageTypes:[it]},ot={name:"invite-notify"};let at=class extends Ze{};at=c([Xe("ACK")],at);const ct={name:"labeled-response",messageTypes:[at],usesTags:!0},ht={name:"message-tags",usesTags:!0},lt={name:"multi-prefix"};class ut{constructor(e,t,...n){this._client=e,this._originalMessage=t,this._messages=[],this._endEventHandlers=new Map,this._types=new Set(n)}untilEvent(e){this._cleanEndEventHandler(e);const t=this._client.on(e,(()=>this.end()));this._endEventHandlers.set(e,t)}async promise(){return this._promise||(this._promise=new Promise((e=>this._promiseResolve=e))),await this._promise}collect(e){return!!this._originalMessage._acceptsInReplyCollection(e)&&(this._messages.push(e),e.endsResponseTo(this._originalMessage)&&this.end(),!0)}end(){this._client.stopCollect(this),this._cleanEndEventHandlers(),this._promiseResolve&&this._promiseResolve(this._messages)}_cleanEndEventHandlers(){this._endEventHandlers.forEach((e=>this._client.removeListener(e))),this._endEventHandlers.clear()}_cleanEndEventHandler(e){this._endEventHandlers.has(e)&&(this._client.removeListener(this._endEventHandlers.get(e)),this._endEventHandlers.delete(e))}}let pt=class extends Ze{};c([et()],pt.prototype,"password",void 0),pt=c([Xe("PASS")],pt);let dt=class extends Ze{};c([et()],dt.prototype,"nick",void 0),dt=c([Xe("NICK")],dt);let gt=class extends Ze{};c([et()],gt.prototype,"user",void 0),c([et()],gt.prototype,"mode",void 0),c([et()],gt.prototype,"unused",void 0),c([et({trailing:!0})],gt.prototype,"realName",void 0),gt=c([Xe("USER")],gt);let mt=class extends Ze{};c([et()],mt.prototype,"name",void 0),c([et()],mt.prototype,"password",void 0),mt=c([Xe("OPER")],mt);let ft=class extends Ze{};c([et({trailing:!0,optional:!0})],ft.prototype,"message",void 0),ft=c([Xe("QUIT")],ft);let yt=class extends Ze{};c([et()],yt.prototype,"server",void 0),c([et({trailing:!0})],yt.prototype,"message",void 0),yt=c([Xe("SQUIT")],yt);let vt=class extends Ze{};c([et({type:"channel"})],vt.prototype,"channel",void 0),c([et({optional:!0})],vt.prototype,"key",void 0),vt=c([Xe("JOIN")],vt);let _t=class extends Ze{};c([et({type:"channel"})],_t.prototype,"channel",void 0),c([et({trailing:!0,optional:!0})],_t.prototype,"reason",void 0),_t=c([Xe("PART")],_t);class wt extends Error{constructor(e){super(`Unknown channel mode character ${e}`),this._char=e,Object.setPrototypeOf(this,wt.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,wt)}get char(){return this._char}}let bt=class extends Ze{get isChannel(){return Ke(this.params.target,this._serverProperties.channelTypes)}separate(){const e=[],t=this.params.modes;if(!t)throw new Error("can't separate a channel mode request, just set actions");const n=t.split(" "),s=n.shift();let i="add";for(const t of s){let s=i;switch(t){case"+":i="add";break;case"-":i="remove";break;default:{let r=!1,o=!0;if(this.isChannel){if(this._serverProperties.supportedChannelModes.alwaysWithParam.includes(t)||this._serverProperties.supportedChannelModes.prefix.includes(t))r=!0;else if(this._serverProperties.supportedChannelModes.paramWhenSet.includes(t))"add"===i&&(r=!0);else if(this._serverProperties.supportedChannelModes.list.includes(t))n.length?r=!0:s="getList";else if(!this._serverProperties.supportedChannelModes.noParam.includes(t))throw new wt(t)}else o=this._serverProperties.supportedUserModes.includes(t);if(r&&!n.length)continue;e.push({prefix:this._prefix,action:s,letter:t,param:r?n.shift():void 0,known:o})}}}return e}};c([et()],bt.prototype,"target",void 0),c([et({rest:!0,optional:!0})],bt.prototype,"modes",void 0),bt=c([Xe("MODE")],bt);let Ct=class extends Ze{};c([et({type:"channel"})],Ct.prototype,"channel",void 0),c([et({optional:!0,trailing:!0})],Ct.prototype,"newTopic",void 0),Ct=c([Xe("TOPIC")],Ct);let kt=class extends Ze{};kt.SUPPORTS_CAPTURE=!0,c([et({type:"channelList",optional:!0})],kt.prototype,"channel",void 0),kt=c([Xe("NAMES")],kt);let Tt=class extends Ze{};c([et({optional:!0})],Tt.prototype,"channel",void 0),c([et({optional:!0})],Tt.prototype,"server",void 0),Tt=c([Xe("LIST")],Tt);let Rt=class extends Ze{};c([et()],Rt.prototype,"target",void 0),c([et({type:"channel"})],Rt.prototype,"channel",void 0),Rt=c([Xe("INVITE")],Rt);let xt=class extends Ze{};c([et({type:"channel"})],xt.prototype,"channel",void 0),c([et()],xt.prototype,"target",void 0),c([et({trailing:!0,optional:!0})],xt.prototype,"comment",void 0),xt=c([Xe("KICK")],xt);let Et=class extends Ze{};c([et({optional:!0})],Et.prototype,"server",void 0),Et=c([Xe("TIME")],Et);let St=class extends Ze{};c([et()],St.prototype,"target",void 0),c([et({trailing:!0})],St.prototype,"content",void 0),St=c([Xe("PRIVMSG")],St);let It=class extends Ze{};c([et()],It.prototype,"target",void 0),c([et({trailing:!0})],It.prototype,"content",void 0),It=c([Xe("NOTICE")],It);let Nt=class extends Ze{};c([et()],Nt.prototype,"mask",void 0),c([et({optional:!0})],Nt.prototype,"flags",void 0),c([et({optional:!0,trailing:!0})],Nt.prototype,"extendedMask",void 0),Nt=c([Xe("WHO")],Nt);let Ot=class extends Ze{};c([et({optional:!0})],Ot.prototype,"server",void 0),c([et()],Ot.prototype,"nickMask",void 0),Ot=c([Xe("WHOIS")],Ot);let At=class extends Ze{};c([et()],At.prototype,"nickname",void 0),c([et({optional:!0})],At.prototype,"count",void 0),c([et({optional:!0})],At.prototype,"server",void 0),At=c([Xe("WHOWAS")],At);let Pt=class extends Ze{};c([et()],Pt.prototype,"target",void 0),c([et({trailing:!0,optional:!0})],Pt.prototype,"reason",void 0),Pt=c([Xe("KILL")],Pt);let Mt=class extends Ze{};c([et({trailing:!0})],Mt.prototype,"message",void 0),Mt=c([Xe("PING")],Mt);let jt=class extends Ze{};c([et({noClient:!0})],jt.prototype,"server",void 0),c([et({trailing:!0})],jt.prototype,"message",void 0),jt=c([Xe("PONG")],jt);let Lt=class extends Ze{};c([et({trailing:!0})],Lt.prototype,"content",void 0),Lt=c([Xe("ERROR")],Lt);let $t=class extends Ze{};c([et({trailing:!0,optional:!0})],$t.prototype,"message",void 0),$t=c([Xe("AWAY")],$t);let Ut=class extends Ze{};Ut=c([Xe("REHASH")],Ut);let Dt=class extends Ze{};Dt=c([Xe("RESTART")],Dt);let qt=class extends Ze{};c([et({trailing:!0})],qt.prototype,"content",void 0),qt=c([Xe("WALLOPS")],qt);let Ft=class extends Ze{};c([et({rest:!0})],Ft.prototype,"nicks",void 0),Ft=c([Xe("USERHOST")],Ft);let Bt=class extends Ze{};var Wt;c([et({rest:!0})],Bt.prototype,"nicks",void 0),Bt=c([Xe("ISON")],Bt);let Gt=Wt=class extends Ze{isResponseTo(e){if(!(e instanceof Wt))return!1;switch(this.params.subCommand){case"ACK":case"NAK":return"REQ"===e.params.subCommand&&e.params.capabilities===this.params.capabilities.trim();case"LS":case"LIST":return e.params.subCommand===this.params.subCommand;default:return!1}}endsResponseTo(e){if(!(e instanceof Wt))return!1;switch(this.params.subCommand){case"LS":case"LIST":return!this.params.continued;default:return!0}}};Gt.SUPPORTS_CAPTURE=!0,c([et({match:/^(?:[a-z_\-\[\]\\^{}|`][a-z0-9_\-\[\]\\^{}|`]+|\*)$/i,optional:!0,noClient:!0})],Gt.prototype,"target",void 0),c([et({match:/^(?:LS|LIST|REQ|ACK|NAK|END|NEW|DEL)$/i})],Gt.prototype,"subCommand",void 0),c([et({match:/^\d+$/,optional:!0})],Gt.prototype,"version",void 0),c([et({match:/^\*$/,optional:!0})],Gt.prototype,"continued",void 0),c([et({trailing:!0,optional:!0})],Gt.prototype,"capabilities",void 0),Gt=Wt=c([Xe("CAP")],Gt);let Ht=class extends Ze{};c([et()],Ht.prototype,"target",void 0),Ht=c([Xe("TAGMSG")],Ht);let zt=class extends Ze{};c([et()],zt.prototype,"me",void 0),c([et({trailing:!0})],zt.prototype,"welcomeText",void 0),zt=c([Xe("001")],zt);let Qt=class extends Ze{};c([et()],Qt.prototype,"me",void 0),c([et({trailing:!0})],Qt.prototype,"yourHost",void 0),Qt=c([Xe("002")],Qt);let Kt=class extends Ze{};c([et()],Kt.prototype,"me",void 0),c([et({trailing:!0})],Kt.prototype,"createdText",void 0),Kt=c([Xe("003")],Kt);let Jt=class extends Ze{};c([et()],Jt.prototype,"me",void 0),c([et()],Jt.prototype,"serverName",void 0),c([et()],Jt.prototype,"version",void 0),c([et()],Jt.prototype,"userModes",void 0),c([et()],Jt.prototype,"channelModes",void 0),c([et({optional:!0})],Jt.prototype,"channelModesWithParam",void 0),Jt=c([Xe("004")],Jt);let Vt=class extends Ze{};c([et()],Vt.prototype,"me",void 0),c([et({rest:!0})],Vt.prototype,"supports",void 0),c([et({trailing:!0})],Vt.prototype,"suffix",void 0),Vt=c([Xe("005")],Vt);let Yt=class extends Ze{};c([et()],Yt.prototype,"me",void 0),c([et()],Yt.prototype,"modes",void 0),Yt=c([Xe("221")],Yt);let Zt=class extends Ze{};c([et()],Zt.prototype,"me",void 0),c([et()],Zt.prototype,"nick",void 0),c([et({trailing:!0})],Zt.prototype,"content",void 0),Zt=c([Xe("301")],Zt);let Xt=class extends Ze{};c([et()],Xt.prototype,"me",void 0),c([et({trailing:!0})],Xt.prototype,"hosts",void 0),Xt=c([Xe("302")],Xt);let en=class extends Ze{};c([et()],en.prototype,"me",void 0),c([et({trailing:!0})],en.prototype,"suffix",void 0),en=c([Xe("305")],en);let tn=class extends Ze{};c([et()],tn.prototype,"me",void 0),c([et({trailing:!0})],tn.prototype,"suffix",void 0),tn=c([Xe("306")],tn);let nn=class extends Ze{};c([et()],nn.prototype,"me",void 0),c([et()],nn.prototype,"nick",void 0),c([et()],nn.prototype,"username",void 0),c([et()],nn.prototype,"host",void 0),c([et()],nn.prototype,"_unused",void 0),c([et({trailing:!0})],nn.prototype,"realname",void 0),nn=c([Xe("311")],nn);let sn=class extends Ze{isResponseTo(e){return e instanceof Nt}endsResponseTo(){return!0}};c([et()],sn.prototype,"me",void 0),c([et()],sn.prototype,"query",void 0),c([et({trailing:!0})],sn.prototype,"suffix",void 0),sn=c([Xe("315")],sn);let rn=class extends Ze{};c([et()],rn.prototype,"me",void 0),c([et()],rn.prototype,"nickMask",void 0),c([et({trailing:!0})],rn.prototype,"suffix",void 0),rn=c([Xe("318")],rn);let on=class extends Ze{};c([et()],on.prototype,"me",void 0),c([et()],on.prototype,"nick",void 0),c([et({trailing:!0})],on.prototype,"channels",void 0),on=c([Xe("319")],on);let an=class extends Ze{};c([et()],an.prototype,"me",void 0),c([et({type:"channel"})],an.prototype,"channel",void 0),c([et()],an.prototype,"memberCount",void 0),c([et({trailing:!0})],an.prototype,"topic",void 0),an=c([Xe("322")],an);let cn=class extends Ze{};c([et()],cn.prototype,"me",void 0),c([et({trailing:!0})],cn.prototype,"suffix",void 0),cn=c([Xe("323")],cn);let hn=class extends Ze{};c([et()],hn.prototype,"me",void 0),c([et({type:"channel"})],hn.prototype,"channel",void 0),c([et({rest:!0})],hn.prototype,"modes",void 0),hn=c([Xe("324")],hn);let ln=class extends Ze{};c([et()],ln.prototype,"me",void 0),c([et({type:"channel"})],ln.prototype,"channel",void 0),c([et({trailing:!0})],ln.prototype,"suffix",void 0),ln=c([Xe("331")],ln);let un=class extends Ze{};c([et()],un.prototype,"me",void 0),c([et({type:"channel"})],un.prototype,"channel",void 0),c([et({trailing:!0})],un.prototype,"topic",void 0),un=c([Xe("332")],un);let pn=class extends Ze{};c([et()],pn.prototype,"me",void 0),c([et({type:"channel"})],pn.prototype,"channel",void 0),c([et()],pn.prototype,"who",void 0),c([et()],pn.prototype,"ts",void 0),pn=c([Xe("333")],pn);let dn=class extends Ze{};c([et()],dn.prototype,"me",void 0),c([et()],dn.prototype,"nick",void 0),c([et({type:"channel"})],dn.prototype,"channel",void 0),dn=c([Xe("341")],dn);let gn=class extends Ze{};c([et()],gn.prototype,"me",void 0),c([et({type:"channel"})],gn.prototype,"channel",void 0),c([et()],gn.prototype,"mask",void 0),c([et({optional:!0})],gn.prototype,"creatorName",void 0),c([et({optional:!0})],gn.prototype,"timestamp",void 0),gn=c([Xe("348")],gn);let mn=class extends Ze{};c([et()],mn.prototype,"me",void 0),c([et({type:"channel"})],mn.prototype,"channel",void 0),c([et({trailing:!0})],mn.prototype,"suffix",void 0),mn=c([Xe("349")],mn);let fn=class extends Ze{get isAway(){return this.params.flags.includes("G")}get isOper(){return this.params.flags.includes("*")}get isBot(){return this.params.flags.includes("B")}isResponseTo(e){return e instanceof Nt}};c([et()],fn.prototype,"me",void 0),c([et()],fn.prototype,"channel",void 0),c([et()],fn.prototype,"user",void 0),c([et()],fn.prototype,"host",void 0),c([et()],fn.prototype,"server",void 0),c([et()],fn.prototype,"nick",void 0),c([et()],fn.prototype,"flags",void 0),c([et({trailing:!0})],fn.prototype,"hopsAndRealName",void 0),fn=c([Xe("352")],fn);let yn=class extends Ze{isResponseTo(e){return e instanceof kt}};c([et()],yn.prototype,"me",void 0),c([et()],yn.prototype,"channelType",void 0),c([et({type:"channel"})],yn.prototype,"channel",void 0),c([et({trailing:!0})],yn.prototype,"names",void 0),yn=c([Xe("353")],yn);let vn=class extends Ze{isResponseTo(e){return e instanceof kt}endsResponseTo(){return!0}};c([et()],vn.prototype,"me",void 0),c([et()],vn.prototype,"channel",void 0),c([et({trailing:!0})],vn.prototype,"suffix",void 0),vn=c([Xe("366")],vn);let _n=class extends Ze{};c([et()],_n.prototype,"me",void 0),c([et({type:"channel"})],_n.prototype,"channel",void 0),c([et()],_n.prototype,"mask",void 0),c([et({optional:!0})],_n.prototype,"creatorName",void 0),c([et({optional:!0})],_n.prototype,"timestamp",void 0),_n=c([Xe("367")],_n);let wn=class extends Ze{};c([et()],wn.prototype,"me",void 0),c([et({type:"channel"})],wn.prototype,"channel",void 0),c([et({trailing:!0})],wn.prototype,"suffix",void 0),wn=c([Xe("368")],wn);let bn=class extends Ze{};c([et()],bn.prototype,"me",void 0),c([et({trailing:!0})],bn.prototype,"line",void 0),bn=c([Xe("372")],bn);let Cn=class extends Ze{};c([et()],Cn.prototype,"me",void 0),c([et({trailing:!0})],Cn.prototype,"line",void 0),Cn=c([Xe("375")],Cn);let kn=class extends Ze{};c([et()],kn.prototype,"me",void 0),c([et({trailing:!0})],kn.prototype,"suffix",void 0),kn=c([Xe("376")],kn);let Tn=class extends Ze{};c([et()],Tn.prototype,"me",void 0),c([et({trailing:!0})],Tn.prototype,"suffix",void 0),Tn=c([Xe("381")],Tn);let Rn=class extends Ze{};c([et()],Rn.prototype,"me",void 0),c([et({optional:!0})],Rn.prototype,"server",void 0),c([et({trailing:!0})],Rn.prototype,"timestamp",void 0),Rn=c([Xe("391")],Rn);let xn=class extends Ze{};c([et()],xn.prototype,"me",void 0),c([et()],xn.prototype,"nick",void 0),c([et({trailing:!0})],xn.prototype,"suffix",void 0),xn=c([Xe("401")],xn);let En=class extends Ze{};c([et()],En.prototype,"me",void 0),c([et()],En.prototype,"server",void 0),c([et({trailing:!0})],En.prototype,"suffix",void 0),En=c([Xe("402")],En);let Sn=class extends Ze{};c([et()],Sn.prototype,"me",void 0),c([et({})],Sn.prototype,"channel",void 0),c([et({trailing:!0})],Sn.prototype,"suffix",void 0),Sn=c([Xe("403")],Sn);let In=class extends Ze{};c([et()],In.prototype,"me",void 0),c([et({type:"channel"})],In.prototype,"channel",void 0),c([et({trailing:!0})],In.prototype,"suffix",void 0),In=c([Xe("404")],In);let Nn=class extends Ze{};c([et()],Nn.prototype,"me",void 0),c([et({type:"channel"})],Nn.prototype,"channel",void 0),c([et({trailing:!0})],Nn.prototype,"suffix",void 0),Nn=c([Xe("405")],Nn);let On=class extends Ze{};c([et()],On.prototype,"me",void 0),c([et()],On.prototype,"subCommand",void 0),c([et({trailing:!0})],On.prototype,"suffix",void 0),On=c([Xe("410")],On);let An=class extends Ze{isResponseTo(e){return e.command===this.params.originalCommand}endsResponseTo(){return!0}};c([et()],An.prototype,"me",void 0),c([et()],An.prototype,"originalCommand",void 0),c([et({trailing:!0})],An.prototype,"suffix",void 0),An=c([Xe("421")],An);let Pn=class extends Ze{};c([et()],Pn.prototype,"me",void 0),c([et({trailing:!0})],Pn.prototype,"suffix",void 0),Pn=c([Xe("422")],Pn);let Mn=class extends Ze{isResponseTo(e){return"NICK"===e.command}endsResponseTo(){return!0}};c([et()],Mn.prototype,"me",void 0),c([et({trailing:!0})],Mn.prototype,"suffix",void 0),Mn=c([Xe("431")],Mn);let jn=class extends Ze{isResponseTo(e){return"NICK"===e.command}endsResponseTo(){return!0}};c([et()],jn.prototype,"me",void 0),c([et()],jn.prototype,"nick",void 0),c([et({trailing:!0})],jn.prototype,"suffix",void 0),jn=c([Xe("432")],jn);let Ln=class extends Ze{isResponseTo(e){return"NICK"===e.command}endsResponseTo(){return!0}};c([et()],Ln.prototype,"me",void 0),c([et()],Ln.prototype,"nick",void 0),c([et({trailing:!0})],Ln.prototype,"suffix",void 0),Ln=c([Xe("433")],Ln);let $n=class extends Ze{isResponseTo(e){return"NICK"===e.command}endsResponseTo(){return!0}};c([et()],$n.prototype,"me",void 0),c([et()],$n.prototype,"nick",void 0),c([et({trailing:!0})],$n.prototype,"suffix",void 0),$n=c([Xe("436")],$n);let Un=class extends Ze{isResponseTo(e){return"NICK"===e.command}endsResponseTo(){return!0}};c([et()],Un.prototype,"me",void 0),c([et()],Un.prototype,"nick",void 0),c([et({type:"channel"})],Un.prototype,"channel",void 0),c([et({trailing:!0})],Un.prototype,"suffix",void 0),Un=c([Xe("441")],Un);let Dn=class extends Ze{isResponseTo(e){return"NICK"===e.command}endsResponseTo(){return!0}};c([et()],Dn.prototype,"me",void 0),c([et({type:"channel"})],Dn.prototype,"channel",void 0),c([et({trailing:!0})],Dn.prototype,"suffix",void 0),Dn=c([Xe("442")],Dn);let qn=class extends Ze{isResponseTo(e){return"NICK"===e.command}endsResponseTo(){return!0}};c([et()],qn.prototype,"me",void 0),c([et()],qn.prototype,"nick",void 0),c([et({type:"channel"})],qn.prototype,"channel",void 0),c([et({trailing:!0})],qn.prototype,"suffix",void 0),qn=c([Xe("443")],qn);let Fn=class extends Ze{};c([et()],Fn.prototype,"me",void 0),c([et({trailing:!0})],Fn.prototype,"suffix",void 0),Fn=c([Xe("451")],Fn);let Bn=class extends Ze{};c([et()],Bn.prototype,"me",void 0),c([et()],Bn.prototype,"originalCommand",void 0),c([et({trailing:!0})],Bn.prototype,"suffix",void 0),Bn=c([Xe("461")],Bn);let Wn=class extends Ze{};c([et()],Wn.prototype,"me",void 0),c([et({trailing:!0})],Wn.prototype,"suffix",void 0),Wn=c([Xe("462")],Wn);let Gn=class extends Ze{};c([et()],Gn.prototype,"me",void 0),c([et({type:"channel"})],Gn.prototype,"channel",void 0),c([et({trailing:!0})],Gn.prototype,"suffix",void 0),Gn=c([Xe("471")],Gn);let Hn=class extends Ze{};c([et()],Hn.prototype,"me",void 0),c([et()],Hn.prototype,"char",void 0),c([et({trailing:!0})],Hn.prototype,"suffix",void 0),Hn=c([Xe("472")],Hn);let zn=class extends Ze{};c([et()],zn.prototype,"me",void 0),c([et({type:"channel"})],zn.prototype,"channel",void 0),c([et({trailing:!0})],zn.prototype,"suffix",void 0),zn=c([Xe("473")],zn);let Qn=class extends Ze{};c([et()],Qn.prototype,"me",void 0),c([et({type:"channel"})],Qn.prototype,"channel",void 0),c([et({trailing:!0})],Qn.prototype,"suffix",void 0),Qn=c([Xe("474")],Qn);let Kn=class extends Ze{};c([et()],Kn.prototype,"me",void 0),c([et({type:"channel"})],Kn.prototype,"channel",void 0),c([et({trailing:!0})],Kn.prototype,"suffix",void 0),Kn=c([Xe("475")],Kn);let Jn=class extends Ze{};c([et()],Jn.prototype,"me",void 0),c([et()],Jn.prototype,"channel",void 0),c([et({trailing:!0})],Jn.prototype,"suffix",void 0),Jn=c([Xe("479")],Jn);let Vn=class extends Ze{};c([et()],Vn.prototype,"me",void 0),c([et({trailing:!0})],Vn.prototype,"suffix",void 0),Vn=c([Xe("481")],Vn);let Yn=class extends Ze{};c([et()],Yn.prototype,"me",void 0),c([et()],Yn.prototype,"channel",void 0),c([et({trailing:!0})],Yn.prototype,"suffix",void 0),Yn=c([Xe("482")],Yn);let Zn=class extends Ze{};c([et()],Zn.prototype,"me",void 0),c([et({trailing:!0})],Zn.prototype,"suffix",void 0),Zn=c([Xe("491")],Zn);let Xn=class extends Ze{};c([et()],Xn.prototype,"me",void 0),c([et({optional:!0,match:/^\w$/})],Xn.prototype,"modeChar",void 0),c([et({trailing:!0})],Xn.prototype,"suffix",void 0),Xn=c([Xe("501")],Xn);let es=class extends Ze{};c([et()],es.prototype,"me",void 0),c([et({trailing:!0})],es.prototype,"suffix",void 0),es=c([Xe("502")],es);const ts=new Map([...Object.values(t),...Object.values(i)].map((e=>[e.COMMAND,e])));function ns(e){const[t,n]=De(e,"!",2);if(n){const[e,s]=De(n,"@",2);return s?{nick:t,user:e,host:s}:{nick:t,host:e}}return{nick:t}}const ss={":":";",n:"\n",r:"\r",s:" "};function is(e){const t=new Map,n=e.split(";");for(const e of n){const[n,s]=De(e,"=",2);""!==n&&t.set(n,s?s.replace(/\\(.?)/g,((e,t)=>Object.prototype.hasOwnProperty.call(ss,t)?ss[t]:t)):"")}return t}class rs extends te{constructor(t){super(),this._registered=!1,this._supportsCapabilities=!0,this._events=new Map,this._registeredMessageTypes=new Map,this.onConnect=this.registerEvent(),this.onRegister=this.registerEvent(),this.onDisconnect=this.registerEvent(),this.onPrivmsg=this.registerEvent(),this.onAction=this.registerEvent(),this.onNotice=this.registerEvent(),this.onNickChange=this.registerEvent(),this.onCtcp=this.registerEvent(),this.onCtcpReply=this.registerEvent(),this.onPasswordError=this.registerEvent(),this.onAnyMessage=this.registerEvent(),this._serverProperties=Be(ze),this._supportedFeatures={},this._collectors=[],this._clientCapabilities=new Map,this._serverCapabilities=new Map,this._negotiatedCapabilities=new Map,this._currentChannels=new Set,this._hasRegisteredBefore=!1,this._channelsFromLastRegister=new Set,this._initialConnectionSetupDone=!1;const{connection:n,credentials:s,channels:i,channelTypes:r,webSocket:o,logger:a={}}=t;this._options=t;const{pingOnInactivity:c=60,pingTimeout:h=10}=n;this._pingOnInactivity=c,this._pingTimeout=h,this._currentNick=s.nick,this._logger=G({name:"ircv3",emoji:!0,...a}),this.registerCoreMessageTypes();const{hostName:l,secure:u,reconnect:p=!0}=n,d={hostName:l,port:this.port,secure:u},g={lineBased:!0,logger:this._logger,additionalOptions:t.connectionOptions},m=o?je:Le;this._connection=p?new $e(m,d,g):new m(g,this._logger,t.connectionOptions);for(const t of Object.values(e))this.addCapability(t);this.addInternalListener(this.onRegister,(async()=>{const e=this._hasRegisteredBefore,t=this._channelsFromLastRegister;this._hasRegisteredBefore=!0,this._channelsFromLastRegister=new Set;const n=e&&this._options.rejoinChannelsOnReconnect?t:await Y(i);if(n)for(const e of n)this.join(e)})),this.onTypedMessage(Gt,(async({params:{subCommand:e,capabilities:t}})=>{const n=t.split(" ");switch(e.toUpperCase()){case"NEW":{this._logger.debug(`Server registered new capabilities: ${n.join(", ")}`);const e=Ue(n,(e=>{if(!e)return{};const[t,n]=De(e,"=",2);return{[t]:{name:t,param:n||!0}}}));for(const[t,n]of Object.entries(e))this._serverCapabilities.set(t,n);const t=Object.keys(e);await this._negotiateCapabilities(Array.from(this._clientCapabilities.entries()).filter((([e])=>t.includes(e))).map((([,e])=>e)));break}case"DEL":this._logger.debug(`Server removed capabilities: ${n.join(", ")}`);for(const e of n)this._serverCapabilities.delete(e),this._negotiatedCapabilities.delete(e)}})),this.onTypedMessage(Mt,(({params:{message:e}})=>{this.sendMessage(jt,{message:e})})),this.onTypedMessage(zt,(({params:{me:e}})=>this._handleReceivedClientNick(e))),this.onTypedMessage(Jt,(({params:{userModes:e}})=>{e&&(this._serverProperties.supportedUserModes=e)})),this.onTypedMessage(Vt,(({params:{supports:e}})=>{const t=Ue(e.split(" "),(e=>{const[t,n]=De(e,"=",2);return{[t]:n||!0}}));this._supportedFeatures={...this._supportedFeatures,...t}})),this.onTypedMessage(kn,(({params:{me:e}})=>{this._registered||(this._handleReceivedClientNick(e),this._registered=!0,this.emit(this.onRegister))})),this.onTypedMessage(Pn,(({params:{me:e}})=>{this._registered||(this._handleReceivedClientNick(e),this._registered=!0,this.emit(this.onRegister))})),this.onTypedMessage(Wn,(({params:{me:e}})=>{this._registered||(this._logger.warn("We thought we're not registered yet, but we actually are"),this._handleReceivedClientNick(e),this._registered=!0,this.emit(this.onRegister))})),this.onTypedMessage(St,(e=>{var t;const{params:{target:n,content:s}}=e,i=Ve(s),r=null===(t=e.prefix)||void 0===t?void 0:t.nick;i?"ACTION"===i.command?this.emit(this.onAction,n,r,i.params,e):this.emit(this.onCtcp,n,r,i.command,i.params,e):this.emit(this.onPrivmsg,n,r,s,e)})),this.onTypedMessage(dt,(e=>{var t;const{params:{nick:n}}=e,s=null===(t=e.prefix)||void 0===t?void 0:t.nick;s===this._currentNick&&(this._currentNick=n),this.emit(this.onNickChange,s,n,e)})),this.onTypedMessage(It,(e=>{var t;const{params:{target:n,content:s}}=e,i=Ve(s),r=null===(t=e.prefix)||void 0===t?void 0:t.nick;i&&this.emit(this.onCtcpReply,n,r,i.command,i.params,e),this.emit(this.onNotice,n,r,s,e)})),this._options.manuallyAcknowledgeJoins||this.onTypedMessage(vt,(e=>{var t;(null===(t=e.prefix)||void 0===t?void 0:t.nick)===this._currentNick&&this.acknowledgeJoin(e.params.channel)})),this.onTypedMessage(_t,(e=>{var t;(null===(t=e.prefix)||void 0===t?void 0:t.nick)===this._currentNick&&(this._currentChannels.delete(e.params.channel),this._channelsFromLastRegister.delete(e.params.channel))})),this.addInternalListener(this.onRegister,(()=>this._startPingCheckTimer())),this._desiredNick=s.nick,this._userName=s.userName,this._realName=s.realName,r&&(this._serverProperties.channelTypes=r)}receiveLine(e){var t;let n;this._logger.debug(`Received message: ${e}`);try{n=function(e,t=ze,n=ts,s=!1,i=[],r=!0){const o=e.split(" ");let a,c;const h=[];let l,u;for(;o.length;){if(a=o[0],!a.startsWith("@")||l||c||u)if(a.startsWith(":")){if(u||c){h.push({value:o.join(" ").substr(1),trailing:!0});break}a.length>1&&(u=ns(a.substr(1)))}else c?h.push({value:a,trailing:!1}):c=a.toUpperCase();else l=is(a.substr(1));o.shift()}if(l||(l=new Map),!c)throw new Error(`line without command received: ${e}`);let p=Ze;return n.has(c)&&(p=n.get(c)),new p(c,h,l,u,t,e,s,r&&!i.includes(c))}(e,this._serverProperties,this._registeredMessageTypes,!0,this._options.nonConformingCommands)}catch(e){return this._logger.error(`Error parsing message: ${e.message}`),void this._logger.trace(null!==(t=e.stack)&&void 0!==t?t:"No stack available")}this._logger.trace(`Parsed message: ${JSON.stringify(n)}`),this._startPingCheckTimer(),this.emit(this.onAnyMessage,n),this._handleEvents(n)}get serverProperties(){return Be(this._serverProperties)}get port(){const{webSocket:e,connection:{port:t,secure:n}}=this._options;return t||(e?n?443:80:n?6697:6667)}pingCheck(){const e=Date.now(),t=e.toString(),n=this.onTypedMessage(jt,(s=>{const{params:{message:i}}=s;i===t&&(this._logger.debug(`Current ping: ${Date.now()-e}ms`),this._pingTimeoutTimer&&clearTimeout(this._pingTimeoutTimer),this.removeMessageListener(n))}));this._pingTimeoutTimer=setTimeout((()=>{this.removeMessageListener(n),!1===this._options.connection.reconnect?this._logger.error(`Disconnecting because the last ping took over ${this._pingTimeout} seconds`):this._logger.warn(`Reconnecting because the last ping took over ${this._pingTimeout} seconds`),this._connection.assumeExternalDisconnect()}),1e3*this._pingTimeout),this.sendMessage(Mt,{message:t})}reconnect(e){this.quit(e),this.connect()}registerMessageType(e){""!==e.COMMAND&&(this._logger.trace(`Registering message type ${e.COMMAND}`),this._registeredMessageTypes.set(e.COMMAND.toUpperCase(),e))}knowsCommand(e){return this._registeredMessageTypes.has(e.toUpperCase())}getCommandClass(e){return this._registeredMessageTypes.get(e.toUpperCase())}acknowledgeJoin(e){this._currentChannels.add(e),this._channelsFromLastRegister.add(e)}connect(){this._supportsCapabilities=!1,this._negotiatedCapabilities=new Map,this._currentChannels=new Set,this._currentNick=this._desiredNick,this._setupConnection(),this._logger.info(`Connecting to ${this._options.connection.hostName}:${this.port}`),this._connection.connect()}addCapability(e){if(this._clientCapabilities.set(e.name,e),e.messageTypes)for(const t of Object.values(e.messageTypes))this.registerMessageType(t)}async registerCapability(e){return this.addCapability(e),this._serverCapabilities.has(e.name)?await this._negotiateCapabilities([e]):[]}send(e){this.sendRaw(e.toString())}sendRaw(e){this._connection.isConnected&&(this._logger.debug(`Sending message: ${e}`),this._connection.sendLine(e))}onNamedMessage(e,t,n){this._events.has(e)||this._events.set(e,new Map);const s=this._events.get(e);if(!n)do{n=`${e}:${qe(1e4*Math.random(),4,"0")}`}while(s.has(n));return s.set(n,t),n}onTypedMessage(e,t,n){return this.onNamedMessage(e.COMMAND,t,n)}removeMessageListener(e){const[t]=e.split(":");this._events.has(t)&&this._events.get(t).delete(e)}createMessage(e,t,n){return function(e,t,n,s,i=ze,r=!1){const o=new e(e.COMMAND,void 0,void 0,void 0,i),a={};return e.PARAM_SPEC&&Fe(e.PARAM_SPEC,((n,s)=>{if((!r||!n.noServer)&&(r||!n.noClient)){if(s in t){const r=t[s];if(void 0!==r)if(e.checkParam(r,n,i))a[s]={value:r,trailing:Boolean(n.trailing)};else if(!n.optional)throw new Error(`required parameter "${s}" did not suit requirements: "${r}"`)}if(!(s in a)&&!n.optional)throw new Error(`required parameter "${s}" not found in command "${e.COMMAND}"`)}})),Object.assign(o,a),o._initPrefixAndTags(n,s),o}(e,t,void 0,n?new Map(Object.entries(n)):void 0,this.serverProperties)}sendMessage(e,t,n){this.send(this.createMessage(e,t,n))}async sendMessageAndCaptureReply(e,t){if(!e.SUPPORTS_CAPTURE)throw new Error(`The command "${e.COMMAND}" does not support reply capture`);const n=this.createMessage(e,t),s=this.collect(n).promise();return this.send(n),await s}get isConnected(){return this._connection.isConnected}get isConnecting(){return this._connection.isConnecting}get isRegistered(){return this._registered}get currentNick(){return this._currentNick}get currentChannels(){return Array.from(this._currentChannels)}collect(e,...t){const n=new ut(this,e,...t);return this._collectors.push(n),n}stopCollect(e){this._collectors.splice(this._collectors.findIndex((t=>t===e)),1)}join(e,t){this.sendMessage(vt,{channel:e,key:t})}part(e){this.sendMessage(_t,{channel:e})}quit(e){this.sendMessage(ft,{message:e}),this.quitAbruptly()}quitAbruptly(){this._registered=!1,this._connection.disconnect()}say(e,t,n={}){this.sendMessage(St,{target:e,content:t},n)}sendCtcp(e,t,n){this.say(e,`${t.toUpperCase()} ${n}`)}action(e,t){this.sendCtcp(e,"ACTION",t)}changeNick(e){this._currentNick!==e&&(this._desiredNick=e,this.isRegistered&&this.sendMessage(dt,{nick:e}))}registerCoreMessageTypes(){Fe(t,(e=>{this.registerMessageType(e)})),Fe(i,(e=>{this.registerMessageType(e)}))}async _negotiateCapabilityBatch(e){return await Promise.all(e.filter((e=>e.length)).map((async e=>await this._negotiateCapabilities(e))))}async _negotiateCapabilities(e){const t=Ue(e,(e=>({[e.name]:e}))),n=(await this.sendMessageAndCaptureReply(Gt,{subCommand:"REQ",capabilities:e.map((e=>e.name)).join(" ")})).shift();if(!n)throw new Error("capability negotiation failed unexpectedly without any reply");if(!(n instanceof Gt))throw new Error(`capability negotiation failed unexpectedly with "${n.command}" command`);const s=n.params.capabilities.split(" ").filter((e=>e));if("ACK"===n.params.subCommand){this._logger.debug(`Successfully negotiated capabilities: ${s.join(", ")}`);const e=s.map((e=>t[e]));for(const t of e){const e=this._clientCapabilities.get(t.name);e.param=t.param,this._negotiatedCapabilities.set(e.name,e)}return e}return this._logger.warn(`Failed to negotiate capabilities: ${s.join(", ")}`),new Error("capabilities failed to negotiate")}_setupConnection(){this._initialConnectionSetupDone||(this._connection.onConnect((async()=>{var e,t;this._logger.info(`Connection to server ${this._options.connection.hostName}:${this.port} established`),this.emit(this.onConnect),this._logger.debug("Determining connection password");try{const[n]=await Promise.all([Y(this._options.credentials.password),this.sendMessageAndCaptureReply(Gt,{subCommand:"LS",version:"302"}).then((e=>{if(!(e.length&&e[0]instanceof Gt))return this._logger.debug("Server does not support capabilities"),[];this._supportsCapabilities=!0;const t=e.map((e=>Ue(e.params.capabilities.split(" "),(e=>{if(!e)return{};const[t,n]=De(e,"=",2);return{[t]:{name:t,param:n||!0}}}))));this._serverCapabilities=new Map(Object.entries(Object.assign({},...t))),this._logger.debug(`Capabilities supported by server: ${Array.from(this._serverCapabilities.keys()).join(", ")}`);const n=t.map((e=>{const t=Object.keys(e);return Array.from(this._clientCapabilities.entries()).filter((([e])=>t.includes(e))).map((([,e])=>e))}));return this._negotiateCapabilityBatch(n)})).then((()=>{this.sendMessage(Gt,{subCommand:"END"})}))]);n&&this.sendMessage(pt,{password:n}),this.sendMessage(dt,{nick:this._desiredNick}),this.sendMessage(gt,{user:null!==(e=this._userName)&&void 0!==e?e:this._desiredNick,mode:"8",unused:"*",realName:null!==(t=this._realName)&&void 0!==t?t:this._desiredNick})}catch(e){this.emit(this.onPasswordError,e),this.quit()}})),this._initialConnectionSetupDone=!0,this._connection.onReceive((e=>{this.receiveLine(e)})),this._connection.onDisconnect(((e,t)=>{var n;if(this._registered=!1,this._pingCheckTimer&&clearTimeout(this._pingCheckTimer),this._pingTimeoutTimer&&clearTimeout(this._pingTimeoutTimer),e)this._logger.info("Disconnected");else{const e=null===(n=this._options.connection.reconnect)||void 0===n||n,s=t?`Disconnected unexpectedly: ${t.message}`:"Disconnected unexpectedly";e?this._logger.warn(`${s}; trying to reconnect`):this._logger.error(s)}this.emit(this.onDisconnect,e,t)})),this._connection.onEnd((e=>{e||this._logger.warn("No further retries will be made")})))}_handleReceivedClientNick(e){this._currentNick!==e&&(""!==this._currentNick&&this._logger.warn(`Mismatching nicks: passed ${this._currentNick}, but you're actually ${e}`),this._currentNick=e)}_handleEvents(e){this._collectors.some((t=>t.collect(e)));const t=this._events.get(e.constructor.COMMAND);if(t)for(const n of t.values())n(e)}_startPingCheckTimer(){this._pingCheckTimer&&clearTimeout(this._pingCheckTimer),this._connection.isConnected?this._pingCheckTimer=setTimeout((()=>this.pingCheck()),1e3*this._pingOnInactivity):this._pingCheckTimer=void 0}}c([X(!1)],rs.prototype,"_options",void 0),Error;let os=class extends Ze{get date(){const e=this._tags.get("tmi-sent-ts");return new Date(Number(e))}get channelId(){return this._tags.get("room-id")}get targetUserId(){var e;return null!==(e=this._tags.get("target-user-id"))&&void 0!==e?e:null}};c([et({type:"channel"})],os.prototype,"channel",void 0),c([et({trailing:!0,optional:!0})],os.prototype,"user",void 0),os=c([Xe("CLEARCHAT")],os);class as extends Ze{}as.COMMAND="RECONNECT";let cs=class extends Ze{};function hs(e){return p([],u(e),!1).length}function ls(e,t,n){return p([],u(e),!1).slice(t,n).join("")}c([et({type:"channel"})],cs.prototype,"channel",void 0),cs=c([Xe("ROOMSTATE")],cs);let us=class extends ye{get id(){return this[fe].id}get code(){return this[fe].code}getUrl(e){const{animationSettings:t="default",backgroundType:n="dark",size:s="1.0"}=e;return`https://static-cdn.jtvnw.net/emoticons/v2/${this.id}/${t}/${n}/${s}`}};function ps(e,t,n){if(!e)return[];const s=function(e,t){return[...t.entries()].flatMap((([t,n])=>n.map((n=>{const[s,i]=n.split("-"),r=+s,o=+i,a=ls(e,r,o+1);return{type:"emote",position:r,length:o-r+1,id:t,name:a,displayInfo:new us({code:a,id:t})}})))).sort(((e,t)=>e.position-t.position))}(e,t);return n&&(s.push(...function(e,t){const n=[],s=new RegExp("(?<=^|\\s)([a-z]+(?:\\d+[a-z]+)*)(\\d+)(?=\\s|$)","gi");let i=null;for(;i=s.exec(e);){const s=i[1].toLowerCase();if(t.includes(s)){const t=Number(i[2]);n.push({name:s,amount:t,position:hs(e.slice(0,i.index)),length:i[0].length})}}return n}(e,n).map((e=>({type:"cheer",...e})))),s.sort(((e,t)=>e.position-t.position))),function(e,t){const n=hs(e);if(!t.length)return[{type:"text",position:0,length:n,text:e}];const s=[];let i=0;for(const n of t)n.position>i&&s.push({type:"text",position:i,length:n.position-i,text:ls(e,i,n.position)}),s.push(n),i=n.position+n.length;return i<n&&s.push({type:"text",position:i,length:n-i,text:ls(e,i)}),s}(e,s)}function ds(e){switch(typeof e){case"undefined":return"";case"object":{if(null===e)return"";if("cacheKey"in e)return e.cacheKey;const t=JSON.stringify(e);if("{}"!==t)return t}default:return e.toString()}}function gs(e,t,n){return[e,...t.map(ds)].join("/")+(n?"/":"")}function ms(e=1/0){return function(t,n,s){if(s.get){const t=s.get;s.get=function(){const s=gs(n,[]),i=this.getFromCache(s);if(i)return i;const r=t.call(this);return this.setCache(s,r,e),r}}return s}}var fs;us=c([ve("common","ChatEmote","id")],us);let ys=fs=class{constructor(e,t){this._userName=e.toLowerCase(),this._userData=t?new Map(t):new Map}static _parseBadgesLike(e){return e?new Map(e.split(",").map((e=>{const t=e.indexOf("/");return-1===t?[e,""]:[e.slice(0,t),e.slice(t+1)]}))):new Map}get userName(){return this._userName}get displayName(){var e;return null!==(e=this._userData.get("display-name"))&&void 0!==e?e:this._userName}get color(){return this._userData.get("color")}get badges(){const e=this._userData.get("badges");return fs._parseBadgesLike(e)}get badgeInfo(){const e=this._userData.get("badge-info");return fs._parseBadgesLike(e)}get userId(){return this._userData.get("user-id")}get userType(){return this._userData.get("user-type")}get isBroadcaster(){return this.badges.has("broadcaster")}get isSubscriber(){return this.badges.has("subscriber")||this.isFounder}get isFounder(){return this.badges.has("founder")}get isMod(){return this.badges.has("moderator")}get isVip(){return this.badges.has("vip")}get isArtist(){return this.badges.has("artist-badge")}};function vs(e){return e?new Map(e.split("/").map((e=>{const[t,n]=e.split(":",2);return n?[t,n.split(",")]:null})).filter((e=>null!==e))):new Map}function _s(e,t){if(e.length<=t)return[e];e=e.trim();const n=[];let s=0,i=t;for(;s<e.length;){let r=e.lastIndexOf(" ",i);(-1===r||r<=s||e.length-s+1<=t)&&(r=s+t);const o=e.slice(s,r).trim();o.length&&n.push(o),s=r+(" "===e[r]?1:0),i=s+t}return n}function ws(e){const t=Ve(e);return t&&"ACTION"===t.command?t.params:e}c([X(!1)],ys.prototype,"_userData",void 0),c([ms()],ys.prototype,"badges",null),c([ms()],ys.prototype,"badgeInfo",null),ys=fs=c([function(e){return class extends e{constructor(){super(...arguments),this.cache=new Map}getFromCache(e){if(this._cleanCache(),this.cache.has(e)){const t=this.cache.get(e);if(t)return t.value}}setCache(e,t,n){this.cache.set(e,{value:t,expires:Date.now()+1e3*n})}removeFromCache(e,t){const n=this._getInternalCacheKey(e,t);t?this.cache.forEach(((e,t)=>{t.startsWith(n)&&this.cache.delete(t)})):this.cache.delete(n)}_cleanCache(){const e=Date.now();this.cache.forEach(((t,n)=>{t.expires<e&&this.cache.delete(n)}))}_getInternalCacheKey(e,t){if("string"==typeof e){let t=e;return t.endsWith("/")||(t+="/"),t}return gs(e.shift(),e,t)}}},ve("chat","ChatUser","userId")],ys);let bs=class extends Ze{get id(){return this._tags.get("id")}get date(){const e=this._tags.get("tmi-sent-ts");return new Date(Number(e))}get userInfo(){return new ys(this._tags.get("login"),this._tags)}get channelId(){var e;return null!==(e=this._tags.get("room-id"))&&void 0!==e?e:null}get emoteOffsets(){return vs(this._tags.get("emotes"))}parseEmotes(){return ps(ws(this.params.message),this.emoteOffsets)}};c([et({type:"channel"})],bs.prototype,"channel",void 0),c([et({trailing:!0,optional:!0})],bs.prototype,"message",void 0),bs=c([Xe("USERNOTICE")],bs);let Cs=class extends Ze{};c([et({type:"channel"})],Cs.prototype,"type",void 0),Cs=c([Xe("USERSTATE")],Cs);let ks=class extends Ze{get userInfo(){return new ys(this._prefix.nick,this._tags)}get emoteOffsets(){return vs(this._tags.get("emotes"))}parseEmotes(){return ps(ws(this.params.message),this.emoteOffsets)}};c([et()],ks.prototype,"target",void 0),c([et({trailing:!0})],ks.prototype,"message",void 0),ks=c([Xe("WHISPER")],ks);const Ts={name:"twitch.tv/commands",messageTypes:[os,as,cs,bs,Cs,ks]},Rs={name:"twitch.tv/membership"};class xs extends Ze{get date(){const e=this._tags.get("tmi-sent-ts");return new Date(Number(e))}get userName(){return this._tags.get("login")}get channelId(){return this._tags.get("room-id")}get targetMessageId(){return this._tags.get("target-msg-id")}}xs.COMMAND="CLEARMSG",c([et({type:"channel"})],xs.prototype,"channel",void 0),c([et({trailing:!0})],xs.prototype,"message",void 0);class Es extends Ze{}Es.COMMAND="GLOBALUSERSTATE";const Ss={name:"twitch.tv/tags",messageTypes:[Es,xs]};let Is=class extends St{get id(){return this._tags.get("id")}get date(){const e=this._tags.get("tmi-sent-ts");return new Date(Number(e))}get userInfo(){return new ys(this._prefix.nick,this._tags)}get channelId(){var e;return null!==(e=this._tags.get("room-id"))&&void 0!==e?e:null}get isCheer(){return this._tags.has("bits")}get isRedemption(){return Boolean(this._tags.get("custom-reward-id"))}get rewardId(){return this._tags.get("custom-reward-id")||null}get isFirst(){return"1"===this._tags.get("first-msg")}get isReturningChatter(){return"1"===this._tags.get("returning-chatter")}get isHighlight(){return"highlighted-message"===this._tags.get("msg-id")}get isReply(){return this._tags.has("reply-parent-msg-id")}get parentMessageId(){var e;return null!==(e=this._tags.get("reply-parent-msg-id"))&&void 0!==e?e:null}get parentMessageText(){var e;return null!==(e=this._tags.get("reply-parent-msg-body"))&&void 0!==e?e:null}get parentMessageUserId(){var e;return null!==(e=this._tags.get("reply-parent-user-id"))&&void 0!==e?e:null}get parentMessageUserName(){var e;return null!==(e=this._tags.get("reply-parent-user-login"))&&void 0!==e?e:null}get parentMessageUserDisplayName(){var e;return null!==(e=this._tags.get("reply-parent-display-name"))&&void 0!==e?e:null}get bits(){var e;return Number(null!==(e=this._tags.get("bits"))&&void 0!==e?e:0)}get emoteOffsets(){return vs(this._tags.get("emotes"))}parseEmotes(){return ps(ws(this.params.content),this.emoteOffsets)}parseEmotesAndBits(e,t){return ps(ws(this.params.content),this.emoteOffsets,e.getPossibleNames()).map((n=>"cheer"===n.type?{...n,displayInfo:e.getCheermoteDisplayInfo(n.name,n.amount,t)}:n))}};Is=c([ve("chat","TwitchPrivateMessage","id")],Is);const Ns=/^[a-z0-9][a-z0-9_]{0,24}$/;function Os(e){return`#${function(e){const t=e.replace(/^#/,"").toLowerCase();if(!Ns.test(t))throw new Error(`"${t}" is not a valid user or channel name. It must be at most 25 characters long, can only include letters, numbers and underscores, and can not start with an underscore.`);return t}(e)}`}var As;let Ps=As=class extends te{constructor(e={}){var t,n,s,i,r;if(e.authProvider&&!e.authProvider.getAccessTokenForIntent)throw new se("You can not connect to chat using an AuthProvider that does not support intents.\nTo get an anonymous, read-only connection, please don't pass an `AuthProvider` at all.\nTo get a read-write connection, please provide an auth provider that provides user access tokens via intents, such as `RefreshingAuthProvider`.");super(),this._authVerified=!1,this._authRetryCount=0,this.onConnect=this.registerEvent(),this.onDisconnect=this.registerEvent(),this.onTimeout=this.registerEvent(),this.onBan=this.registerEvent(),this.onBitsBadgeUpgrade=this.registerEvent(),this.onChatClear=this.registerEvent(),this.onEmoteOnly=this.registerEvent(),this.onFollowersOnly=this.registerEvent(),this.onJoin=this.registerEvent(),this.onJoinFailure=this.registerEvent(),this.onPart=this.registerEvent(),this.onMessageRemove=this.registerEvent(),this.onR9k=this.registerEvent(),this.onUniqueChat=this.registerEvent(),this.onRaid=this.registerEvent(),this.onRaidCancel=this.registerEvent(),this.onRitual=this.registerEvent(),this.onSlow=this.registerEvent(),this.onSubsOnly=this.registerEvent(),this.onSub=this.registerEvent(),this.onResub=this.registerEvent(),this.onSubGift=this.registerEvent(),this.onCommunitySub=this.registerEvent(),this.onSubExtend=this.registerEvent(),this.onRewardGift=this.registerEvent(),this.onPrimePaidUpgrade=this.registerEvent(),this.onGiftPaidUpgrade=this.registerEvent(),this.onPrimeCommunityGift=this.registerEvent(),this.onStandardPayForward=this.registerEvent(),this.onCommunityPayForward=this.registerEvent(),this.onAnnouncement=this.registerEvent(),this.onWhisper=this.registerEvent(),this.onNoPermission=this.registerEvent(),this.onMessageRatelimit=this.registerEvent(),this.onAuthenticationSuccess=this.registerEvent(),this.onAuthenticationFailure=this.registerEvent(),this.onTokenFetchFailure=this.registerEvent(),this.onMessageFailed=this.registerEvent(),this.onMessage=this.registerEvent(),this.onAction=this.registerEvent(),this._onJoinResult=this.registerInternalEvent(),this._ircClient=new rs({connection:{hostName:null!==(t=e.hostName)&&void 0!==t?t:null===(n=e.webSocket)||void 0===n||n?"irc-ws.chat.twitch.tv":"irc.chat.twitch.tv",secure:null===(s=e.ssl)||void 0===s||s},credentials:{nick:"",password:async()=>await this._getAuthToken()},webSocket:null===(i=e.webSocket)||void 0===i||i,connectionOptions:e.connectionOptions,logger:{name:"twurple:chat:irc",...e.logger},nonConformingCommands:["004"],manuallyAcknowledgeJoins:!0,rejoinChannelsOnReconnect:e.rejoinChannelsOnReconnect}),this._ircClient.onDisconnect(((e,t)=>{this._messageRateLimiter.clear(),this._messageRateLimiter.pause(),this._joinRateLimiter.clear(),this._joinRateLimiter.pause(),this.emit(this.onDisconnect,e,t)})),this._ircClient.registerMessageType(Is),this._chatLogger=G({name:"twurple:chat:twitch",...e.logger}),this._authProvider=e.authProvider,this._useLegacyScopes=!!e.legacyScopes,this._readOnly=!!e.readOnly,this._authIntents=[...null!==(r=e.authIntents)&&void 0!==r?r:[],"chat"];const o=async({type:e,text:t,channel:n,tags:s})=>{"say"===e?this._ircClient.say(n,t,s):this._ircClient.action(n,t)};if(e.isAlwaysMod)this._messageRateLimiter=new Q({bucketSize:"verified"===e.botLevel?7500:100,timeFrame:32e3,doRequest:o});else{let t=20;"verified"===e.botLevel?t=7500:"known"===e.botLevel&&(t=50),this._messageRateLimiter=new K(new J({bucketSize:1,timeFrame:1200,logger:{minLevel:g.ERROR},doRequest:o,getPartitionKey:({channel:e})=>e}),{bucketSize:t,timeFrame:32e3})}this._joinRateLimiter=new Q({bucketSize:"verified"===e.botLevel?2e3:20,timeFrame:11e3,doRequest:async e=>{const{promise:t,resolve:n,reject:s}=V();let i;const r=this.addInternalListener(this._onJoinResult,((t,o,a)=>{t===e&&(clearTimeout(i),a?s(a):n(),this.removeListener(r))}));i=setTimeout((()=>{this.removeListener(r),this.emit(this._onJoinResult,e,void 0,"twurple_timeout"),s(new Error(`Did not receive a reply to join ${e} in time; assuming that the join failed`))}),1e4),this._ircClient.join(e),await t}}),this._messageRateLimiter.pause(),this._joinRateLimiter.pause(),this._ircClient.addCapability(Ss),this._ircClient.addCapability(Ts),e.requestMembershipEvents&&this._ircClient.addCapability(Rs),this._ircClient.onConnect((()=>{this.emit(this.onConnect)})),this._ircClient.onRegister((async()=>{this._messageRateLimiter.resume(),this._joinRateLimiter.resume(),this._authVerified=!0,this._authRetryTimer=void 0,this._authRetryCount=0,this.emit(this.onAuthenticationSuccess);const t=await Y(e.channels);t&&await Promise.all(t.map((async e=>{var t;try{await this.join(e)}catch(n){this._chatLogger.warn(`Failed to join configured channel ${e}; original message: ${null!==(t=null==n?void 0:n.message)&&void 0!==t?t:n}`)}})))})),this._ircClient.onPasswordError((e=>{this._chatLogger.error(`Error fetching a token for connecting to the server: ${e.message}`),this.emit(this.onTokenFetchFailure,e)})),this._ircClient.onPrivmsg(((e,t,n,s)=>{"jtv"!==t&&this.emit(this.onMessage,e,t,n,s)})),this._ircClient.onAction(((e,t,n,s)=>{this.emit(this.onAction,e,t,n,s)})),this.addInternalListener(this._onJoinResult,((e,t,n)=>{n?this.emit(this.onJoinFailure,e,n):this._ircClient.acknowledgeJoin(e)})),this._ircClient.onTypedMessage(os,(e=>{const{params:{channel:t,user:n},tags:s}=e;if(n){const i=s.get("ban-duration");void 0===i?this.emit(this.onBan,t,n,e):this.emit(this.onTimeout,t,n,Number(i),e)}else this.emit(this.onChatClear,t,e)})),this._ircClient.onTypedMessage(xs,(e=>{const{params:{channel:t},targetMessageId:n}=e;this.emit(this.onMessageRemove,t,n,e)})),this._ircClient.onTypedMessage(vt,(({prefix:e,params:{channel:t}})=>{this.emit(this.onJoin,t,e.nick)})),this._ircClient.onTypedMessage(_t,(({prefix:e,params:{channel:t}})=>{this.emit(this.onPart,t,e.nick)})),this._ircClient.onTypedMessage(cs,(({params:{channel:e},tags:t})=>{let n=!1;if(t.has("subs-only")&&t.has("slow")&&(this.emit(this._onJoinResult,e,t),n=!0),!n){if(t.has("slow")){const n=Number(t.get("slow"));n?this.emit(this.onSlow,e,!0,n):this.emit(this.onSlow,e,!1)}if(t.has("followers-only")){const n=Number(t.get("followers-only"));-1===n?this.emit(this.onFollowersOnly,e,!1):this.emit(this.onFollowersOnly,e,!0,n)}}})),this._ircClient.onTypedMessage(bs,(e=>{const{params:{channel:t,message:n},tags:s}=e,i=s.get("msg-id");switch(i){case"sub":case"resub":{const r="sub"===i?this.onSub:this.onResub,o=s.get("msg-param-sub-plan"),a=s.get("msg-param-streak-months"),c={userId:s.get("user-id"),displayName:s.get("display-name"),plan:o,planName:s.get("msg-param-sub-plan-name"),isPrime:"Prime"===o,months:Number(s.get("msg-param-cumulative-months")),streak:a?Number(a):void 0,message:n};if("true"===s.get("msg-param-was-gifted")){const e="true"===s.get("msg-param-anon-gift"),t=Number(s.get("msg-param-gift-months")),n=Number(s.get("msg-param-gift-month-being-redeemed"));c.originalGiftInfo=e?{anonymous:!0,duration:t,redeemedMonth:n}:{anonymous:!1,duration:t,redeemedMonth:n,userId:s.get("msg-param-gifter-id"),userName:s.get("msg-param-gifter-login"),userDisplayName:s.get("msg-param-gifter-name")}}this.emit(r,t,s.get("login"),c,e);break}case"subgift":{const n=s.get("msg-param-sub-plan"),i=s.get("login"),r="ananonymousgifter"===i,o={userId:s.get("msg-param-recipient-id"),displayName:s.get("msg-param-recipient-display-name"),gifter:r?void 0:i,gifterUserId:r?void 0:s.get("user-id"),gifterDisplayName:r?void 0:s.get("display-name"),gifterGiftCount:r?void 0:Number(s.get("msg-param-sender-count")),giftDuration:Number(s.get("msg-param-gift-months")),plan:n,planName:s.get("msg-param-sub-plan-name"),isPrime:"Prime"===n,months:Number(s.get("msg-param-months"))};this.emit(this.onSubGift,t,s.get("msg-param-recipient-user-name"),o,e);break}case"submysterygift":{const n=s.get("login"),i="ananonymousgifter"===n,r={gifter:i?void 0:n,gifterUserId:i?void 0:s.get("user-id"),gifterDisplayName:i?void 0:s.get("display-name"),gifterGiftCount:i?void 0:Number(s.get("msg-param-sender-count")),count:Number(s.get("msg-param-mass-gift-count")),plan:s.get("msg-param-sub-plan")};this.emit(this.onCommunitySub,t,s.get("login"),r,e);break}case"primepaidupgrade":{const n={userId:s.get("user-id"),displayName:s.get("display-name"),plan:s.get("msg-param-sub-plan")};this.emit(this.onPrimePaidUpgrade,t,s.get("login"),n,e);break}case"giftpaidupgrade":{const n={userId:s.get("user-id"),displayName:s.get("display-name"),gifter:s.get("msg-param-sender-login"),gifterDisplayName:s.get("msg-param-sender-name")};this.emit(this.onGiftPaidUpgrade,t,s.get("login"),n,e);break}case"standardpayforward":{const n="true"===s.get("msg-param-prior-gifter-anonymous"),i={userId:s.get("user-id"),displayName:s.get("display-name"),originalGifterUserId:n?void 0:s.get("msg-param-prior-gifter-id"),originalGifterDisplayName:n?void 0:s.get("msg-param-prior-gifter-display-name"),recipientUserId:s.get("msg-param-recipient-id"),recipientDisplayName:s.get("msg-param-recipient-display-name")};this.emit(this.onStandardPayForward,t,s.get("login"),i,e);break}case"communitypayforward":{const n="true"===s.get("msg-param-prior-gifter-anonymous"),i={userId:s.get("user-id"),displayName:s.get("display-name"),originalGifterUserId:n?void 0:s.get("msg-param-prior-gifter-id"),originalGifterDisplayName:n?void 0:s.get("msg-param-prior-gifter-display-name")};this.emit(this.onCommunityPayForward,t,s.get("login"),i,e);break}case"primecommunitygiftreceived":{const n={name:s.get("msg-param-gift-name"),gifter:s.get("login"),gifterDisplayName:s.get("display-name")};this.emit(this.onPrimeCommunityGift,t,s.get("msg-param-recipient"),n,e);break}case"raid":{const n={displayName:s.get("msg-param-displayName"),viewerCount:Number(s.get("msg-param-viewerCount"))};this.emit(this.onRaid,t,s.get("login"),n,e);break}case"unraid":this.emit(this.onRaidCancel,t,e);break;case"ritual":{const i={ritualName:s.get("msg-param-ritual-name"),message:n};this.emit(this.onRitual,t,s.get("login"),i,e);break}case"bitsbadgetier":{const n={displayName:s.get("display-name"),threshold:Number(s.get("msg-param-threshold"))};this.emit(this.onBitsBadgeUpgrade,t,s.get("login"),n,e);break}case"extendsub":{const n={userId:s.get("user-id"),displayName:s.get("display-name"),plan:s.get("msg-param-sub-plan"),months:Number(s.get("msg-param-cumulative-months")),endMonth:Number(s.get("msg-param-sub-benefit-end-month"))};this.emit(this.onSubExtend,t,s.get("login"),n,e);break}case"rewardgift":{const n={domain:s.get("msg-param-domain"),gifterId:s.get("user-id"),gifterDisplayName:s.get("display-name"),count:Number(s.get("msg-param-selected-count")),gifterGiftCount:Number(s.get("msg-param-total-reward-count")),triggerType:s.get("msg-param-trigger-type")};this.emit(this.onRewardGift,t,s.get("login"),n,e);break}case"announcement":{const n={color:s.get("msg-param-color")};this.emit(this.onAnnouncement,t,s.get("login"),n,e);break}default:this._chatLogger.warn(`Unrecognized usernotice ID: ${i}`)}})),this._ircClient.onTypedMessage(ks,(e=>{this.emit(this.onWhisper,e.prefix.nick,e.params.message,e)})),this._ircClient.onTypedMessage(It,(async({params:{target:e,content:t},tags:n})=>{const s=n.get("msg-id");switch(s){case"emote_only_on":this.emit(this.onEmoteOnly,e,!0);break;case"emote_only_off":this.emit(this.onEmoteOnly,e,!1);break;case"msg_channel_suspended":case"msg_banned":this.emit(this._onJoinResult,e,void 0,s);break;case"r9k_on":this.emit(this.onUniqueChat,e,!0),this.emit(this.onR9k,e,!0);break;case"r9k_off":this.emit(this.onUniqueChat,e,!1),this.emit(this.onR9k,e,!1);break;case"subs_on":this.emit(this.onSubsOnly,e,!0);break;case"subs_off":this.emit(this.onSubsOnly,e,!1);break;case"cmds_available":case"followers_on":case"followers_on_zero":case"followers_off":case"slow_on":case"slow_off":case"timeout_success":case"unrecognized_cmd":break;case"no_permission":this.emit(this.onNoPermission,e,t);break;case"msg_ratelimit":this.emit(this.onMessageRatelimit,e,t);break;case"msg_duplicate":case"msg_emoteonly":case"msg_followersonly":case"msg_followersonly_followed":case"msg_followersonly_zero":case"msg_subsonly":case"msg_slowmode":case"msg_r9k":case"msg_verified_email":case"msg_timedout":case"msg_rejected_mandatory":case"msg_channel_blocked":this.emit(this.onMessageFailed,e,s);break;case void 0:if("Login authentication failed"===t||"Improperly formatted AUTH"===t||"Invalid NICK"===t){this._authVerified=!1,this._authRetryTimer||(this._authRetryTimer=Z(120),this._authRetryCount=0);const e=this._authRetryTimer.next().value,n=++this._authRetryCount;this.emit(this.onAuthenticationFailure,t,n),0!==e&&this._chatLogger.info(`Retrying authentication in ${e} seconds`),await function(e){return h(this,void 0,Promise,(function(){return l(this,(function(t){switch(t.label){case 0:return[4,new Promise((function(t){return setTimeout(t,e)}))];case 1:return t.sent(),[2]}}))}))}(1e3*e),this._ircClient.reconnect()}break;default:s.startsWith("usage_")||this._chatLogger.warn(`Unrecognized notice ID: '${s}'`)}}))}async connect(){this._authProvider||this._ircClient.changeNick(As._generateJustinfanNick()),this._ircClient.connect()}get irc(){return this._ircClient}get isConnected(){return this._ircClient.isConnected}get isConnecting(){return this._ircClient.isConnecting}get currentChannels(){return this._ircClient.currentChannels}async say(e,t,n={},s){const i={};var r;n.replyTo&&(i["reply-parent-msg-id"]=(r=n.replyTo)instanceof Is?r.tags.get("id"):r);const o=_s(t,500);await Promise.all(o.map((async t=>await this._messageRateLimiter.request({type:"say",channel:Os(e),text:t,tags:i},s))))}async action(e,t,n){const s=_s(t,490);await Promise.all(s.map((async t=>await this._messageRateLimiter.request({type:"action",channel:Os(e),text:t},n))))}async join(e){await this._joinRateLimiter.request(Os(e))}part(e){this._ircClient.part(Os(e))}quit(){this._ircClient.quitAbruptly()}async reconnect(){this.quit(),await this.connect()}async _getAuthToken(){var e,t;if(!this._authProvider)return void this._chatLogger.debug("No authProvider given; connecting anonymously");if(this._authToken&&!re(this._authToken)&&this._authVerified)return this._chatLogger.debug("AccessToken assumed to be correct from last connection"),`oauth:${this._authToken.accessToken}`;const n=this._getNecessaryScopes();let s,i=!1;for(const r of this._authIntents){try{if(this._authToken=await this._authProvider.getAccessTokenForIntent(r,n),!this._authToken)continue;i=!0;const e=await Ce(this._authToken.accessToken);if(!e.userName)throw new se("Could not determine a user name for your token; you might be trying to disguise an app token as a user token.");return this._ircClient.changeNick(e.userName),`oauth:${this._authToken.accessToken}`}catch(e){e instanceof de?s=e:this._chatLogger.error(`Retrieving an access token failed: ${e.message}`)}this._chatLogger.warn("No valid token available; trying to refresh");try{if(this._authToken=await(null===(t=(e=this._authProvider).refreshAccessTokenForIntent)||void 0===t?void 0:t.call(e,"chat")),this._authToken){const e=await Ce(this._authToken.accessToken);if(!e.userName)throw new se("Could not determine a user name for your token; you might be trying to disguise an app token as a user token.");return this._ircClient.changeNick(e.userName),`oauth:${this._authToken.accessToken}`}}catch(e){e instanceof de?s=e:this._chatLogger.error(`Refreshing the access token failed: ${e.message}`)}}throw this._authVerified=!1,null!=s?s:new Error(i?"Could not retrieve a valid token":`None of the queried intents (${this._authIntents.join(", ")}) are known by the auth provider${this._authProvider instanceof Ae?".\nPlease add one of these to the user you want to connect with using the `addIntentToUser` method or the additional parameter to `addUser` or `addUserForToken`.":""}`)}_getNecessaryScopes(){return this._useLegacyScopes?["chat_login"]:this._readOnly?["chat:read"]:["chat:read","chat:edit"]}static _generateJustinfanNick(){return`justinfan${Math.floor(1e5*Math.random()).toString().padStart(5,"0")}`}};c([X(!1)],Ps.prototype,"_authProvider",void 0),Ps=As=c([ve("chat","ChatClient")],Ps);let Ms=class{constructor(e,t,n){this._clientId=e||"",this._accessToken="string"==typeof t?{accessToken:t,refreshToken:null,scope:null!=n?n:[],expiresIn:null,obtainmentTimestamp:Date.now()}:t,this._scopes=n}get clientId(){return this._clientId}async getAccessTokenForIntent(e,t){return await this._getAccessToken(t)}async getAccessTokenForUser(e,t){return await this._getAccessToken(t)}async getAnyAccessToken(){return await this._getAccessToken()}getCurrentScopesForUser(){var e;return null!==(e=this._scopes)&&void 0!==e?e:[]}async _getAccessToken(e){const[t,n]=await xe(this._clientId,this._accessToken.accessToken,this._userId,this._scopes,e?[e]:[]);return this._scopes=t,this._userId=n,{...this._accessToken,userId:n}}};c([X(!1)],Ms.prototype,"_clientId",void 0),c([X(!1)],Ms.prototype,"_accessToken",void 0),Ms=c([ve("auth","StaticAuthProvider","clientId")],Ms);var js=n(575);function Ls(e){this.message=e}function $s(e){this.message=e}Ls.prototype=new Error,Ls.prototype.name="InvalidCharacterError","undefined"!=typeof window&&window.atob&&window.atob.bind(window),$s.prototype=new Error,$s.prototype.name="InvalidTokenError";const Us="id.twitch.tv",Ds="arosrv3mja0b5ywmhr0dxaa5r7rn3f";let qs=null,Fs=null;async function Bs(e){const t=js.parse(e.replace("#","?"),!0).query;return!!t?.access_token&&(qs=t.access_token,window.hooks.emit("twitch_auth:login_update",!0),!0)}async function Ws(e){Gs();const t=await window.appapi.GetPrimaryDisplay(),{width:n,height:s}=t.workAreaSize;Fs=await window.browser.createBrowserWindow({width:500,height:425,x:n/2-250,y:s/2-212,frame:!0,show:!1,webPreferences:{nodeIntegration:!1,enableRemoteModule:!1}}),window.browser.AlwaysOnTop(Fs,!0),window.browser.browserGo(Fs,"https://"+Us+"/oauth2/authorize?client_id="+Ds+"&redirect_uri=https://local.moemate.io/callback&response_type=token&scope="+encodeURIComponent("user:read:email channel:read:subscriptions channel:moderate chat:edit chat:read whispers:read whispers:edit user:read:follows user:read:broadcast user:edit")),window.browser.onBeforeRequest(Fs,{urls:["https://local.moemate.io/callback*"]},(async e=>await Bs(e)?Gs():Hs())),window.browser.on(Fs,"closed",(()=>{Fs=null})),window.browser.on(Fs,"ready-to-show",(()=>{if(e){var t=Fs;Fs=null,setTimeout((()=>{window.browser.closeBrowserWindow(t)}),3e3)}else window.browser.browserShow(Fs)}))}function Gs(){Fs&&(window.browser.closeBrowserWindow(Fs),Fs=null)}async function Hs(){Gs(),await fetch(`https://${Us}/oauth2/revoke?client_id=${Ds}&token=${qs}`),await async function(){window.browser.ClearAllCookies(`https://${Us}`),qs=null,window.hooks.emit("twitch_auth:login_update",!1)}()}let zs=null;class Qs{clientId=null;scopes="user:read:email channel:read:subscriptions channel:moderate chat:edit chat:read whispers:read whispers:edit user:read:follows user:read:broadcast user:edit";accessToken=null;userInfo=null;chatClient=null;messageCount=0;messageLog=[];permaMessageLog=[];subscriberLog=[];followerLog=[];raidLog=[];auth=null;interval=null;settings={chatTime:45,showChat:!0,showSubs:!0,showRaid:!0,subsOnly:!1,twitchOn:!1};lastEventTime=Date.now();eventQueue=[];constructor(){window.hooks.on("twitch_auth:login_update",(e=>{e?(async function(){return qs}().then((e=>{e&&(this.accessToken=e,async function(){if(!qs)throw new Error("Must authenticate before getting user info");const e=await fetch("https://api.twitch.tv/helix/users",{headers:{"Client-ID":Ds,Authorization:`Bearer ${qs}`}}),t=await e.json();if(t.data&&t.data.length>0)return t.data[0];throw new Error("No user info returned from Twitch API")}().then((e=>{this.userInfo=e,this.toggleTwitch(this.settings.twitchOn),window.hooks.emit("twitch_auth:accountupdate",{signedIn:!0,userInfo:this.userInfo})})))})),async function(){return Ds}().then((e=>{e&&(this.clientId=e)}))):(this.accessToken=null,this.userInfo=null,window.hooks.emit("twitch_auth:accountupdate",{signedIn:!1}))})),window.storage.Get("twitch:settings").then((e=>{e&&(this.settings=JSON.parse(e))})),Ws(!0)}async saveSettings(){await window.storage.Set("twitch:settings",JSON.stringify(this.settings))}getStatus(){return this.settings.twitchOn}isSignedIn(){return null!=this.accessToken}async connectToChat(){if(!this.accessToken)throw new Error("Must authenticate before connecting to chat");const e=this.userInfo;this.auth=new Ms(this.clientId,this.accessToken,this.scopes),this.chatClient=new Ps(this.auth,{channels:[e.login]}),this.chatClient.connect(),console.log(this.chatClient.onAuthenticationSuccess((()=>{console.log("Connected.")}))),this.chatClient.join(e.login),this.chatClient.onMessage((async(e,t,n,s)=>{if(!this.settings.showChat)return;if(this.settings.subsOnly&&!s.userInfo.isSubscriber)return;const i={username:t,message:n};this.messageLog.push(i),this.permaMessageLog.push(i),this.messageCount++,console.log(`Message received: ${n}`)})),this.chatClient.onSub((async(e,t,n,s)=>{if(!this.showSubs)return;const i={username:t,message:n.message,type:"sub"};this.eventQueue.push(i),this.subscriberLog.push(`Sub received from ${t}: ${n.message}\n`),this.messageCount++,console.log(`Sub received: ${n.message}`)})),this.chatClient.onResub((async(e,t,n,s)=>{if(!this.showSubs)return;const i={username:t,months:n.months,message:n.message,type:"resub"};this.eventQueue.push(i),this.subscriberLog.push(`Resub received from ${t}: ${n.message}`),this.messageCount++,console.log(`Resub received: ${n.message}\n`)})),this.chatClient.onRaid((async(e,t,n)=>{if(!this.settings.showRaid)return;const s={username:t,viewers:n.viewerCount,type:"raid"};this.eventQueue.push(s),this.raidLog.push(`Raid received from ${t} with ${n.viewerCount}\n`),this.messageCount++,console.log(`Raid received: ${t}`)}));let t=async()=>{if(this.userInfo=this.userInfo,console.log(this.userInfo),console.log(`Checking for events. Queue length: ${this.eventQueue.length}`),this.messageLog.length>0){const e=[...this.messageLog];this.messageLog=[],this.addTwitchChat(e)}if(this.eventQueue.length>0)for(let e of this.eventQueue)"sub"===e.type?this.addTwitchSub(e):"resub"===e.type?this.addTwitchResub(e):"raid"===e.type&&this.addTwitchRaid(e);this.messageCount>0&&(console.log(`Firing twitchContextRefresh event with ${this.messageCount} messages`),window.companion.Interrupt(),this.messageCount=0),this.eventQueue=[],this.settings.twitchOn&&setTimeout(t,1e3*this.settings.chatTime)};setTimeout(t,1e3*this.settings.chatTime)}async disconnect(){this.interval&&clearInterval(this.interval),this.chatClient=null,this.interval=null}async authenticate(){Ws(!1)}async logOut(){Hs()}setChatTime(e){this.settings.chatTime=e,this.saveSettings()}toggleChat(e){this.settings.showChat=e,this.saveSettings()}toggleSubs(e){this.settings.showSubs=e,this.saveSettings()}toggleRaid(e){this.settings.showRaid=e,this.saveSettings()}toggleSubsOnly(e){this.settings.subsOnly=e,this.saveSettings()}toggleTwitch(e){this.settings.twitchOn=e,e?this.connectToChat():this.disconnect(),this.saveSettings()}getTwitchInfo(){return this.userInfo}getMessageLog(){return this.permaMessageLog.slice(-10)}getSubscriberLog(){return this.subscriberLog.slice(-10)}getRaidLog(){return this.raidLog.slice(-10)}getFollowerLog(){return this.followerLog}addTwitchChat(e){console.log("twitch chat",e),e.forEach((e=>{const t=Date.now(),n={user:"system",type:"TWITCH_CHAT",value:`${e.username}: ${e.message}`,timestamp:t,importance:1};window.companion.SendMessage(n)}))}addTwitchSub(e){const t=Date.now(),n={user:"system",type:"TWITCH_SUB",value:`${e.username} subbed with the message: ${e.message}`,timestamp:t,importance:3};window.companion.SendMessage(n)}addTwitchResub(e){const t=Date.now(),n={user:"system",type:"TWITCH_RESUB",value:`${e.username} subbed for ${e.months} months with the message: ${e.message}`,timestamp:t,importance:3};window.companion.SendMessage(n)}addTwitchRaid(e){const t=Date.now(),n={user:"system",type:"TWITCH_RAID",value:`${e.username} is raiding with ${e.viewers} raiders.`,timestamp:t,importance:4};window.companion.SendMessage(n)}}const Ks=e=>`${e.username}: ${e.message}`;function Js(){zs=new Qs,window.twitchClient=zs}function Vs(){window.hooks.on("twitch:authenticate",(()=>{zs.authenticate()})),window.hooks.on("twitch:logout",(()=>{zs.logOut()})),window.hooks.on("set_prompts",(({model:e,type:t})=>function(e,t){if("chat"==t&&zs.getStatus()){let e=this.getTwitchInfo(),t="Twitch not connected.";e&&(t=`\n## <Display Name>: ${e.display_name}\n## <Description>: ${e.description}\n## <Member Since>: ${e.created_at}`),twitchContext={twitchInfo:t,twitchMessages:zs.getMessageLog().map((e=>Ks(e))),twitchSubscribers:zs.getSubscriberLog(),twitchFollowers:zs.getFollowerLog(),twitchRaids:zs.getRaidLog()},window.models_llm.ApplyContextObject(twitchContext),window.prompts_llm.SetPrompt("moemate-twitch:twitch",{role:"system"})}}(0,t))),window.components.AddComponentToScreen("main-menu","TwitchMenuButton"),window.components.AddComponentToScreen("settings-window","TwitchSettings")}})();var i=s.pi,r=s.S1,o=s.MA;export{i as TwitchClient,r as init,o as preload};